$Id: rsvp_nsr_ingress_utp.txt,v 1.3 2009/08/15 20:07:15 avneesh Exp $

S3.02.P05.T02
{Standard Unit Test Plan Template}

Copyright (C) 2004, Juniper Networks, Inc.

NOTICE: This document contains the proprietary and confidential
information of Juniper Networks, Inc., and must not be
distributed outside of the company without the
permission of Juniper Engineering.

[This document is a template for a standard unit test plan for use in
Juniper engineering projects.  To use this document just change the
contents of appropriate sections (marked with {}).  ANYTHING NOT
MARKED 'AS NECESSARY' MUST BE INCLUDED.  If you do not need to fill
out a section, leave it blank or mark it n/a -- do not delete it.

1.  INTRODUCTION

This document describes the unit test plan for RSVP non-stop routing
functionality for P2P ingress and bypass LSPs.

RLI         : 2720
Tracking PR : 97795
Functional spec : sw-projects/os/nsr/rsvp-funcspec.txt

2.  SETUP

    This section defines the topology, common configs and procedures
    used in the functional tests that follow.

2.1 Topology


                        DUT
       +-------+     +-------+     +-------+
       |  R1   |-----|  R2   |-----|  R3   |
       +-------+     +---+---+     +---+---+
                         |    \        |
                         |     \       |
                         |      \      |
                         |       \     |
                         |        \    |
                     +-------+     +-------+     +-------+
                     |  R4   |-----|  R5   |-----|  R6   |
                     +-------+     +-------+     +-------+

The device under test is a dual-RE m10i.

2.2 Typical config on DUT

    system {
        commit synchronize;
    }
    chassis {
        redundancy {
            graceful-switchover;
        }
    }
    interfaces {
        <...>
    }
    routing-options {
        nonstop-routing;
    }
    protocols {
        rsvp {

            traceoptions {
                file routing size 10m files 2;
                flag nsr-synchronization;
                flag error;
                flag event;
                flag state;
            }
        }
        mpls {
            traceoptions {
                file routing size 10m files 2;
                flag nsr-synchronization;
                flag nsr-synchronization-detail;
                flag error;
                flag state;
            }
            interface all;
        }
        ospf {
            traffic-engineering;
            area 0.0.0.0 {
                interface all;
                interface fxp0.0 {
                    disable;
                }
            }
        }
    }

2.3 Common ingress LSP configuration

    The following LSPs are configured between R2 and R6 for some of
    the general ingress tests below:
    
      1. A label-switched-path with no configured primary or secondary
         path.

      2. A label-switched-path with just a primary path.

      3. A label-switched path with primary and secondary paths, both
         with the same name.

      4. A label-switched path with primary and secondary paths, where
         both paths have different names.
   
      5. A label-switched path with primary and secondary paths, where
         the secondary is also configured to be 'standby'.

      6. Same as the last one where the label-switched path is
         configured to be 'adaptive'.

      7. A label-switched-path configured with no-cspf.

2.4 Ingress steady-state checklist

    The following checklist is used when applicable to verify that the
    standby is correctly following the actions of the master for
    ingress LSPs.

      - Compare the head-end state of LSPs (show mpls lsp) on the
        master and standby REs.

      - Check that replicated state is flagged as 'Resolved' on the
        standby RE in the output of the following commands:

        - show mpls replication path
        - show mpls replication pvc

      - Check the relevant routes look identical on the master and
        standby REs.

      - Check that the signaling state of LSPs (show rsvp session)
        looks identical.

2.5 Ingress switchover checklist

    The following checklist is used when applicable to verify that
    switchover was handled correctly for ingress LSPs.

      - Check if any LSP flapped. Wait for a few minutes to make sure
        that signaling stays up.

      - Check if CSPF and/or resignaling was triggered for any LSPs
        and why. The following commands can be useful:

        show mpls lsp extensive
        show route

      - Check age and content of routes in the routing table and make
        sure that no unnecessary changes were made.

        The command "show route age after 'n secs ago'" may be useful.

2.6 Common bypass LSP configuration

    The following configuration is used for some of the general
    bypass tests below.

    Protected LSPs are configured as necessary to trigger creation of
    bypasses. A mix of LSPs between R1 and R6 and R2 and R6 is used.
    This ensures that we test protection of ingress and transit LSPs
    on R2, the DUT.

       1. One automatic bypass on an interface with no CAC (only
          link-protection configured).

       2. Multiple automatic bypasses on a link-protected interface
          (with 'bandwidth' and 'max-bypasses' configured). Protected
          LSPs are created such that more than one of these bypasses
          get created.

       3. Multiple manual bypasses on an interface providing link
          and node protection.

       4. A manual bypass that has the same name as another manual
          bypass on a different interface.

2.7 Bypass steady-state checklist

    The following checklist is used when testing the bypass code to
    verify that the standby is correctly following the actions of the
    standby:

      - Check that 'show rsvp replication bypass' shows all bypasses
        in resolved state.

      - Check that bypasses are recreated in identical state on the
        standby (show rsvp session, show rsvp session bypass).

      - Check that the number of LSPs protected by a bypass are the 
        same on both REs.

        show rsvp session bypass extensive | grep Tunnel

      - Check that the CAC state of each bypass is the same on both
        REs ('show rsvp session extensive').

      - Check that each data LSP is protected by the same bypass on
        both REs (show rsvp session extensive).

      - Check that routes, including weights, are identical both REs.

2.8 Bypass switchover checklist

    The following checklist is used when applicable to verify that the
    bypass NSR code handled switchover as expected.

    - Check that bypasses remain associated with their respective data
      LSPs.

    - Check age and content of routes and make sure no changes were
      made.

    - Check that bypasses do not go down a few minutes after switchover.

3. FUNCTIONAL TEST CASES

3.1 IDLization of tag inter-RE messages

    Goal: Verify that tag data structures are replicated correctly to the
          standby using the new IDL-based messages.

    Test steps:

      1. Configure NSR

      2. Configure the LSPs described in 2.3 between R2 and R6.

      3. Run the following new commands on the master and the standby
         and verify that the replicated databases look identical on
         both REs.

         show mpls replication path [detail]
         show mpls replication pvc [detail]
         show mpls replication lsp [detail]

     Results: Pass

3.2 Basic steady state operation (ingress LSPs)

    Goal: Verify that standby follows actions of master RE correctly
          for various types of LSPs.

    Test steps: 

      1. Configure NSR.

      2. Configure the LSPs specified in 2.3 between R2 and R6.

      3. Run through the ingress steady-state checklist and verify
         that the standby recreates the state on the master RE.

    Results: Pass

3.3 Basic RE switchover (ingress LSPs)

    Goal: Verify that switchover happens seamlessly for various types
          of ingress LSPs.

    Test steps:

      1. Use the setup for the previous test and wait till the standby
         RE is in steady state.

      2. Trigger an RE switchover.

      3. Run over the ingress switchover checklist.

     Results: Pass

3.4 Config changes (ingress LSPs)

    Goal: Verify that the standby follows the actions of the master
          correctly on various config changes.

    Test steps:

      1. Start with the setup and configuration of the previous test.
         Turn off NSR.

      2. Make various configuration changes one by one.

         - Turn on NSR.

         - Change the 'to' address of an LSP.

         - Change the bandwidth of an LSP.

         - Change the 'from' address of an LSP.

      3. After each configuration change, make sure that the standby
         RE is in a consistent state using the ingress steady-state
         checklist.

    Results: Pass

3.5 Operational commands (ingress LSPs)

    Goal: Verify that the standby follows the actions of the master
          correctly when various operational commands are run.

    Test steps:

      1. Start with the setup and configuration for test 3.1.

      2. Run various operational commands one by one on an LSP,
         including:

         - 'clear mpls lsp' on the master.

         - 'clear mpls lsp' on the standby.
         
         - 'clear rsvp session' on the master.
         
         - 'clear rsvp session' on standby.

         - 'restart routing' on the master.
         
         - 'restart routing' on the standby.

      3. After each command, make sure that the standby RE returns to
         a consistent state using the steady-state checklist.

    Results: Pass

3.6 Ingress LSP path switch

    Goal: Verify that standby follows the actions of the master when
          an LSP switches over from one path to another.

    Test steps:

      1. Configure an LSP from R2 and R6 with two paths, the primary
         path along R2-R3-R5-R6 and a secondary standby along
         R2-R4-R5-R6.

      2. Bring the link R3-R5 down.

      3. Verify that the master RE switches to the standby path.

      4. Run through the steady state checklist to ensure that the
         standby is in a consistent state.

    Results: Pass

3.7 Make-before-break (ingress LSPs).

    Goal: Verify NSR operation through a make-before-break switchover
          of an LSP.

    Test steps:

      1. Configure an LSP from R2 to R6 with the 'adaptive' knob.

      2. Make sure that the LSP is following the shortest path,
         R2-R5-R6.

      3. Raise the metric of the R2-R5 link.

      4. Invoke 'clear mpls lsp reoptimize' for the LSP.
      
      5. Verify that the second RSVP session is created on the master
         and standby.

      6. Verify that the standby continues to use the old instance of
         the path until the new one is fully resolved and up on the
         standby. This should be the case even if the master has
         already switched to the new instance.

     Results: pass

3.8 RE switchover during make-before-break

    Goal: Verify that the software tries to gracefully reroute paths
          which were undergoing make-before-break switchover when an
          RE switchover takes place.
          
          This also tests the code path for handling replicated state
          that is not fully resolved at the time of RE switchover.

    Test steps:

      1. Start with the setup and configuration used the previous
         test.

      2. Trigger make-before-break switchover as before.

      3. Wait till the new instance of the path is up and the master
         has switched to it, but the standby hasn't.

         The replicated path state should show up as 'unresolved' on
         the standby RE.

      4. Execute RE switchover.

      5. Make sure that the standby RE does CSPF for the path again,
         resignals it and then switches to the new instance using
         make-before-break.

    Results: Pass

3.9 LSP Paths - EROs: Configured vs (CSPF) Computed match

    After switch-over, each LSP path's EROs is retraced through fresh
    CSPF recomputation. During this process, additional check is made
    to ensure that any configured EROs appear correctly in the
    computed ERO.

    Following tests are conducted to test this matching algorithm.
    Verify configured Vs Computed EROs match for

      o EROs with only strict entries
      o EROs with only loose entries
      o EROs with different combination of strict and loose entries
      o EROs with no configured entries

    In many of these cases, if a mismatch was found between whats
    configured and whats computed, make-before-break attempt for the
    LSPs was also verified to happen correctly.

    Results: Pass

3.10 Basic steady state operation (bypasses)

     Goal: Verify that standby follows actions of master RE correctly
           for various types of bypass LSPs.

     Test steps: 

       1. Configure NSR.

       2. Bring up the different bypasses specified in 2.6.

       3. Run through the steady-state checklist and verify that the
          standby recreates the state on the master RE.

     Results: pass

3.11 Basic switchover test (bypasses)

     Goal: Verify that switchover happens seamlessly for various types
           of bypass LSPs.

    Test steps:

      1. Use the setup for the previous test and wait till the standby
         RE is in steady state.

      2. Trigger an RE switchover.

      3. Run over the switchover checklist.

    Results: Pass

3.12 Config changes (bypasses)

     Goal: Verify that the standby follows the actions of the master
           correctly on various config changes.

     Test steps:

       1. Start with the setup and configuration for test 3.10.
          Turn off NSR.

        2. Make various configuration changes one by one.

          - Turn on NSR.

          - Increase the bandwidth requirements of a protected LSP.

          - Reduce the bandwidth of a manual bypass such that some
            data LSPs will not be admitted anymore.

          - Deconfigure a manual bypass.

       3. After each configuration change, make sure that the standby
          RE is in a consistent state using the bypass steady-state
          checklist.

     Results: Pass

3.13 Operational commands for bypasses

     Goal: Verify that the standby follows the actions of the master
           correctly when various operational commands are run.

     Test steps:

       1. Start with the setup and configuration for test 3.10.

       2. Run various operational commands one by one, including:

          - 'clear rsvp session' for a protected LSP on the master.

          - 'clear rsvp session' for a protected LSP on the standby.

          - 'clear rsvp session' of a bypass LSP on the master.

          - 'clear rsvp session' of a bypass LSP on the standby.

          - 'restart routing' on the master.

          - 'restart routing' on the standby.

       3. After each command, make sure that the standby RE returns to
          a consistent state using the bypass steady-state checklist.

     Results: Pass

3.14 CAC with manual bypass
     
     Goal: Verify that the standby follows the admission control decisions
           made by the master with manual bypasses.

     Test steps:

       1. Configure two LSPs from R1 to R6 with bandwidth 1k each such
          that they follow path R1-R2-R5-R6.

       2. Configure a single manual bypass with bandwidth 1k to R5 and
          no automatic bypasses on R2.
          
          Only one of the two LSPs should be protected.

       3. Run through the bypass steady-state checklist.

       4. Run 'clear rsvp session' on R2 for the data LSP that passed
          CAC.
          
       5. Repeat till the master RE protects the LSP that previously
          did not pass CAC.

       6. Run through the bypass steady-state checklist.

     Results: Pass

3.15 CAC with automatic bypasses

     Goal: Verify that the standby follows the admission control decisions
           made by the master with automatic bypasses.

     Test steps:

       1. Configure two protected LSPs from R1 to R6 bandwidth 1k each
          such that they follow the path R1-R2-R5-R6.

       2. Config protection using multiple automatic bypasses with
          bandwidth 2k each on R2 for the R2-R5 link.

       3. Verify that one bypass is created to hold both LSPs. Run
          through bypass steady-state checklist.

       4. Increase the bandwidth of one of the protected LSPs to 2k.

       5. Verify that a new bypass is created to hold the newly
          signaled LSP. Run through bypass steady-state checklist.

       6. Reduce the bandwidth of the protected LSP back to 1k.

       7. Verify that the more recent bypass becomes unused.

       8. Run through bypass steady-state checklist.

       9. Wait until the master destroys the unused bypass LSP
          (about three minutes).
          
       10. Run through the bypass steady-state checklist.

     Results: Pass

3.16 Switchover with unfeasible bypass

     Goal: Check that a new master will attempt to bring up a bypass
           that went down before switchover

     Test steps:

       1. Disable interface R2-R3.

       2. Configure one protected LSP along the path R1-R2-R5-R6

       3. Turn on link protection on interface R2-R5.

       4. Wait for a bypass to come up and protect the LSP.

       5. Run through bypass steady-state checklist.
 
       6. Disable link R4-R5 such that the bypass comes down.

       7. Wait for bypass to go down on master and standby.

       8. Trigger switchover.

       9. Bring link R4-R5 back up.

       10. Verify that new master brings bypass up again.

     Results: Pass


4.  BOUNDARY TEST CASES

n/a


5.  REGRESSION TEST CASES

n/a

6.  INTEROP TEST CASES

n/a

7.  MIGRATION & COMPATIBILITY TEST CASES

n/a

8.  TEST COVERAGE REMAINING

1. Testing of applications that use LSPs.

2. Testing at scale.

9.  DEFECTS REMAINING

n/a
