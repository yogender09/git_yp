$Id: nsr_igp_infrastructure_unit_test_plan.txt,v 1.1 2005/12/21 22:46:32 jsyed Exp $

S3.02.P05.T02
{Standard Unit Test Plan Template}

Copyright (C) 2004, Juniper Networks, Inc.

NOTICE: This document contains the proprietary and confidential
information of Juniper Networks, Inc., and must not be
distributed outside of the company without the
permission of Juniper Engineering.

1.  INTRODUCTION

    RLI: 2707: NSR: RPD Infrastructure changes and static route
	       support
    Tracking PR: 61319

    This feature is to replicate router-id from master to standby.

    RLI: 3083: Changes for implementing IGP NSR
    Tracking PR: 62389

    This feature is to provide data replication support for IGPs to
    replicate the NSR information accross REs, master to standby and
    viceversa.

2.  SETUP

    Testing this feature needs a dual RE router running 7.6 and later.

3. FUNCTIONAL TEST CASES

   3.1.	Mirroring sub-system

       1. Mirroring subsystem connection
          Goal: When NSR is enabled on a dual RE router make sure the mirroring
	        substem is establishing connection with standby.
	  Steps: 
		1. Bring up dual RE router with 7.6 release or later.
		2. Enable NSR.
                3. Run "show mirror-data queue" command.
	  Success Criteria: Connection status should say "Connected"
	  Result: Pass

       2. Mirroring subsystem re-connects
          Goal: When NSR is enabled on a dual RE router make sure the mirroring
		substem is re-establishing connection when standby restarts or
		viceversa.
          Steps: 
		1. Bring up dual RE router with 7.6 release or later.
                2. Enable NSR.
		3. Restart rpd on standby or master.
		4. Run "show mirror-data queue" command.
          Success Criteria: Connection status should say "Connected" and "No. of connection resets"
			    should be incremented on the side where RPD is not restarted.
          Result: Pass		    

       3. Mirroring subsystem rx/tx stats
	  Goal: When NSR is enabled on a dual RE router make sure the mirroring
		subsytem rx/tx statistics on master & standby match.
          Steps: 
		1. Bring up dual RE router with 7.6 release or later.
		2. Enable NSR.
		3. Run "show mirror-data queue" command.
          Success Criteria: "No. of bytes sent" on master should match "No. of bytes recieved" on standby
		            and viceversa.
          Result: Pass

       4. Registered mirrored databases
          Goal: Make sure all the expected mirrored databases show under registered
	        databases.
          Steps:
		1. Bring up dual RE router with 7.6 release or later.
		2. Run "show mirror-data registered-databases" command.
          Success Criteria: Should show all the expected databases.
	  Result: Pass (Currenly registered data bases are: Router-ID, ISIS-ADJ, ISIS-SYSYTEMID
	                this may change as new clients use mirroring subsystem for replication)

       5. Database initial sync
          Goal: Make sure all the databases are synced up when NSR is enabled.
	  Steps:
		1. Bring up dual RE router with 7.6 release or later.
		2. Enable NSR.
		3. Run "show mirror-data queue" command.
	  Success Criteria: "No. of database resyncs" should be atleast no. of mirrorred databases
			    registered.
          Result: Pass

       6. Database resyncs
          Goal: Make sure all the databases are resynced when NSR is enabled and standby restarts.
	  Steps:
		1. Bring up dual RE router with 7.6 release or later.
		2. Enable NSR.
		3. Restart rpd on standby 
		4. Run "show mirror-data queue" command.
          Success Criteria: "No. of database resyncs" should be incremented by atleast no. of mirrored
		            databases registered.
          Result: Pass

       7. Mirroring subsystem queue
          Goal: Make sure the mirroring queues are getting flushed properly.
	  Step:
	       1. Bring up dual RE router with 7.6 release or later.
	       2. Enable NSR.
	       3. Run "show mirror-data queue" command continuously multiple times.
	  Success Criteria: Shouldn't see outstanding entries in queue for considerable amount of time
	  Result: Pass

       8  Mirroing resync after RE switchover
	  Goal: Make sure mirroring subsystem on standby will disconnect and reconnect with the old master
		after taking over as master
	  Step:
	       1. Bring up dual RE router with 7.6 release or later
	       2. Enable NSR
	       3. Run "request chasis routing-engine master switch" on master.
	       4. After mastership changes and RPD on current standby(old master) comes up
	          run "show mirror-data queue" on new master(old standby).
	  Success Criteria: Connection status should be "Connected" and "No. of database resyncs" should 
			    be atleast no. of mirrorred databases registered.
	  Result: Pass

       9. Consistency check
          Goal: Turn on consistency check knob and see if it catches any data inconsistencies.
	  Step:
	       1. Bring up dual RE router with 7.6 release or later
	       2. Enable NSR
	       3. Run "test mirror-data consistency-check" command
	       4. Make sure the output of this command says "Consistency check enabled"
	       5. Change router-id etc. or use ISIS's adjacency database to keep mirroring subsystem 
	          running
	       6. Monitor /var/log/message for "mirror consistency error" message, this message
	          would give details like inconsistent database and first 50 bytes of the data.
		  NOTE: The inconsistency check stuff is still experimental and is turned off by
			default. Turning on inconsistency check is little expensive.
	       7. Run "show mirror-data queue" command.
	  Success Criteria: "test mirror-data consistency-check" is toggling knob, should enable/disable
		            alternatively on execution. Make sure 
		            "No. of consistency checks" is going up periodically by atleast no. of 
			    registered mirrored databases for every 5 min.
          Result: Pass

   3.2. Router-id replication

       1. Initial router-id replication(selected or configured)
	  Goal: Make sure router-id is replicated on standby when NSR is enabled on a dual RE router 
		and protocols are notified.
          Steps:
		1. Bring up dual RE router with 7.6 release or later.
		2. Enable NSR and do "commit sync".
		3. Run "show route instance detail" command.
		4. Check ospf
	  Success Criteria: router-id for all routing instances on master and standby should match.
	  Result: Pass
    
      2. Change of router-id reflected on standby
	 Goal: Make sure when router-id changes on master its reflected on standby too, make sure
	       protocols are informed of the change.
	 Steps:
  	       1. Bring up dual RE router with 7.6 release or later.
	       2. Enable NSR and do "commit sync".
	       3. Run "show route instance detail: command.
	       4. Now change the router-id on master either by changing the configured router-id
	          or deleting/deactivating address that is currently selected as router-id
	       5. Run "show router instance detail" command.
	       6  Check ospf
	 Success Criteria: router-id on standby for the corresponding routing instance should change
			   and match the router-id on master.
	 Result: Pass

      3. Configure router-id on standby
         Goal: Make sure when router-id configured on standby is selected instead of replicated router-id
	       Note: NSR for routing protocols may not work in this test scenario, not sure if this is a
		     real test case but the behavior should be predictable when it comes to selecting
		     router-id.
         Steps:
               1. Bring up dual RE router with 7.6 release or later.
	       2. Enable NSR.
	       3. Configure router-id on standby and do not run "commit sync" after this
		  point.
	       4. Run "show router instance detail" command on standby.
	       5. Also deconfigure the router-id
         Success Criteria: router-id on standby for the corresponding routing instance should be the
		           configured router-id on standby. Also make sure when router-id is deconfigured
		           replicated router-id is reused as router-id.
	 Result: Pass

      4. Disable routing
	 Goal: Make sure the RPD is shutting down successfully with NSR enabled
	 Steps:
	       1. Bring up dual RE router with 7.6 release or later.
	       2. Enable NSR.
	       3. Let the mirroring etc. happen for while.
	       4. Now disable routing using "set system process routing disable"
	       5. Make sure RPD is not running anymore
	       6. Repeat the disable part after a switch over
	 Sucess Criteria: RPD shouldn't be running after disabling.
	 Result:
	  
4.  BOUNDARY TEST CASES

    4.1. Mirroring sub-system

	 1. Mirroring sub-system on a single RE/no standby yet.
	    Goal: Make sure there is not mirroring subsystem activity when there is no dual RE.
	    Steps:
		  1. Bring up single RE router with 7.6 release or later/let the master come up
		     first before plugging the standby RE/unplug the standby RE.
		  2. Run "show mirror-data queue"
	    Success Criteria: Connection status should be "Not connected" send/received statistics
			      should be zeroes and queues should be empty.
	    Result: Pass (Tried with singe RE router)

	 2. Enabling/Disabling NSR
	    Goal: Enable/disable NSR continuously and make sure mirroring subsystem is resyncing databases
	          everytime NSR is re-enabled, hopefully this will exercise the corner cases and timing 
		  related issues.
	    Steps:
	          1. Bring up dual RE router with 7.6 release or later.
		  2. Turn on/off NSR.
		  3. Give enough time for RPD on standby to come up and mirroring subystem to establish
		     connection(the later part is not necessary if stress testing the reconnection).
	    Success Criteria: No RPD core dump hopefully. 
	    Result: Pass
	    
	 3. Multiple switchovers
	    Goal: Perform multiple switch over and make sure there are no issues with it
	    Steps:
		  1. Bring up dual RE router with 7.6 release or later
		  2. Turn on NSR.
		  3. Do multiple switchovers
	    Succcess Criteria: No RPD core dump and mirroring subsystem is running normally
	    Result: Pass

    4.2 Router-id replication
    
	1. Replication of null router-id
	   Goal: Make sure null router-id for a routing instance is replicated
	   Steps:
		 1. Bring up dual RE router with 7.6 release or later
		 2. Enable NSR
		 3. Create routing instance with no addresses and no configured router-id
		 4. Run "show route instance detail" on standby
		 5. Also create routing instance with addresses.
		 6. Make sure router-id is replicated
		 7. Delete all addresses configured 
		 8. Run "show route instance detail" on standby
	   Success Criteria: Router-id for the corresponding routing instance on standby should be null
	   Result: Pass
        
	2. Deletion of routing instance
	   Goal: Make sure deletion of routing instance has no issues
	   Step:
		1. Bring up dual RE router with 7.6 or later
		2. Enable NSR
		3. Create routing instance and make sure router-id is replicated
		4. Delete the routing instance
		5. Also deactivate routing and make sure RPD is shutting down successfully.
           Success Criteria: No core dump.
	   Result: Pass
  
5.  REGRESSION TEST CASES

    5.1. Mirroring sub-system
	 This is a new feature and should not effect the regressions. Regressions of clients using the 
	 mirroring subsystem is out of scope of this document.

    5.2. Router-id replication
	 This feature should not effect the router-id selection algorithm on master RE. Make sure 
	 router-id specific regressions and routing-protocols regressions still pass.

6.  INTEROP TEST CASES

    6.1 Mirroring subsystem
	This feature is replication of data between REs within the router, so interoperability does not 
	apply here.

    6.2 Router-id replication
	This feature is for replicating router-id within the router and behavior of routing protocols 
	using the replicated router-id is outside the scope of this document. So interopearbility is 
	not applicable.

7.  MIGRATION & COMPATIBILITY TEST CASES

    Not applicable.

8.  TEST COVERAGE REMAINING

     6.1 Mirroring subsystem
	 
	 1. Test scenarios for OSPF & ISIS mirrored databases will be covered by corresponding unit 
	    test plans.

     6.2 Router-id replication
	 
	 1. The network behavior of test scenarios like having seperate configured router-id on standby 
	    instead of using the replicated router-id from master may be covered by routing protocol's 
	    test plan.

9.  DEFECTS REMAINING

{List PRs filed at dev complete for test failures from this plan
which were not fixed by dev complete.}
