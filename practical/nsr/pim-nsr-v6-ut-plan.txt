$Id: pim-nsr-v6-ut-plan.txt,v 1.3 2009/11/27 07:48:16 vikramna Exp $ 

                  NSR: PIM v6 stateful replication
                  Unit Test Plan 

                  Vikram Nagarajan <vikramna@juniper.net>


Copyright (C) 2009, Juniper Networks, Inc.

NOTICE: This document contains proprietary and confidential
information of Juniper Networks, Inc. and must not be distributed
outside of the company without the permission of Juniper Networks
engineering.

1.  INTRODUCTION

This document can be seen as an extension to the PIM NSR Unit Test Plan. 
The goal is to do the unit-testing in a systematic way focussing 
on IPv6 network. This lists verification using CLI commands, observing 
data structures using gdb and verifying traffic consistencies. 

Supported Platforms: M/MX, T

The recommended sequence to proceed 
    (i)  read the parent UTP document first.
    (ii) read this document. 
    (iii)use the scenario and test cases given in this document.
    (iv) proceed with the test cases present in the parent document. 
 

For functional details, implementation and design details please
refer to the following parent documents. 

http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/pim-nsr-funcspec.txt?rev=1.7&view=log
http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/pim-nsr-designspec.txt?rev=1.3&view=markup

http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/pim-nsr-ut-plan.txt?rev=1.5&view=markup
http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/igmp-nsr-ut-plan.txt?rev=1.3&view=markup



Tracks:
  RLI 9022: NSR: PIM stateful replication IPv6 in Phase 2.
  PR: 
  Functional spec:       sw-projects/os/nsr/pim-nsr-funcspec.txt
  IPv6 Functional spec:  sw-projects/os/nsr/pim-nsr-v6-funcspec.txt
  Design spec:           sw-projects/os/nsr/pim-nsr-designspec.txt


Enabling NSR:
         set routing-options nonstop-routing 
         set chassis redundancy graceful-switchover
         set system commit synchronize

Terminology:
  ISS:  Initial State Sync. This would be done when the backup rpd is just
        starting or NSR just got enabled or if PIM just got enabled on the
        backup rpd already configured for NSR.
  RESO: RE SwitchOver



2.  SETUP Topology

    This document uses a different topology than the parent document. 


            source
             +
             |
             |   ||
             |   ||
             |   ||
             |   ||
             |   \/                   
        +----+-----+  =================>          +-----------+
        |  lo0:100 |                              |   lo0:9   | 
        |          |         ge-0/2/0             |           | 
        |    B     +------------------------------+     G     | 
        |          |        20.1.1.x              |           | 
        | NSR DUT  |         20::x                | NSR DUT   | 
        +----+-----+                              +-----+-----+
             |                                       ge-0/2/3
             |     ||                                   |    ||
             |     ||                                   |    ||
          6.1.1.x  || (SPT)                         40.1.1.x || (RPT)
           6::x    ||                                 40::x  ||
             |     ||                                   |    ||
             |     \/                                   |    \/
         fe-1/3/0                                       |
             |                                       ge-0/1/3
        +----+-----+                              +-----+-----+
        | lo0:101  |                              | lo0:102   | 
        |          |         ge-0/1/0             |           | 
        |    E     +------------------------------+     I     | 
        |          |        30.1.1.x              |           | 
        | NSR DUT  |         30::x                |    RP     | 
        +----+-----+   <==================        +-----------+
         fe-1/3/2.7         (RPT)
             |    
             |    ||
          7.1.1.x ||
           7::x   ||
             |    \/
             |
             +
           Recv

Sample configs are available in /homes/vikramna/NSR-CONFIGS.


3. FUNCTIONAL TEST CASES


3.1 Control Plane Info state sync 

   GOAL: Testing the replication of control-plane info to backup RE 
   STEPS: 
          1. In topology above, configure IPv6 and don't start joins or traffic 
          2. All the below control plane information should be replicated to backup RE 
                 2.a static RPs information 
                 2.b BSR information 
                 2.c Embedded RP information 
                 2.d PIM Neighbors information 
                 2.e PIM Interfaces information 
                 2.f Appropriate timers should be running on the backup
 
          3. Start Joins from downstream             
                 3.a The PIM *,G and S,G Joins should be replicated to backup RE 
                 3.a Appropriate timers should be running on the backup

          4. Stop sending downstream Joins
                 4.a After Joins time out on Master, Backup Joins should go away 
                 4.b Any other control state information related to the Joins should go away on backup. 

          5. Start sending Joins from downstream
          6. Start sending traffic from upstream 
                 6.a Appropriate Joins and Mcast routes will be installed on master RE
                 6.b Appropriate Joins and Mcast routes should be replicated to backup RE 
                 6.c Appropriate timers on Joins and Mcast routes should run on Backup RE 
                 6.d The backup RE should not send out Multicast Control or data packets  

          7. Perform the above checks with switchover. 
                 7.a After switchover, the new master should retain the control state information
                 7.b After switchover, the new master should retain the mcast routes 
                 7.c After switchover, the routers/joins should not be reinstalled 

   CRITERIA:
          1. The RP-set info (static RP, BSR, Embedded-RP) should be replicated and retained after multiple switchovers  
          2. The Join state info should be replicated and retained after multiple switchovers  
          3. The Mcast route state info should be replicated and retained after multiple switchovers  
          4. The timer states should be relevant on backup. 
          5. There should not be any rpd crash. 
          6. Backup rpd should respond to cli operational mode commands 

   RESULT:
        PASS.


3.2 Traffic Flow testing 
   GOAL: Testing the traffic flow during failover/switchover 
   STEPS: 
          1. In topology above, pump traffic from source and send joins from receiver.
          2. Trigger switchovers in E and G using CLI.
          3. Check for traffic loss on the receiver by monitoring using tcpdump on recv.
          4. Do the above with IPv4 alone set of interfaces. Observe the traffic loss pattern.
          5. Do the above with IPv6 alone set of interfaces. Observe the traffic loss pattern.
          6. Do the above with IPv4 and IPv6 set of interfaces configuration. Observe the traffic loss pattern.
          7. Do the switchover multiple times and observe the behavior.


   CRITERIA:
          1. The traffic loss patterns in Step 5 should be similar to that in Step 4. 
          2. The traffic loss patterns in Step 6 should be similar to that in Step 4. 
          3. There should not be excessive traffic loss during and after switchover.
          4. There should not be any rpd crash. 

   RESULT:
        PASS.

3.3 Generic Testing Sequence for different modules

   GOAL: Outlining the generic test procedure to be used in later sections 

   STEPS: 
          1. With 3.1 and 3.2, follow the below steps and check if 3.1 and 3.2 tests pass. 
               1.a Receiver started
               1.b Receiver stopped
               1.c Source started
               1.d Source stopped
               1.e Changing order in which source/receiver show up. 
       
          2. Unicast Routing changed

          3. Modify different config stanzas and check replication and loss as outlined in 3.1 and 3.2 

   CRITERIA:
          1. As and when Joins gets added or times out in master, it should be replicated to backup RE
          2. As and when mroutes gets added or times out in master, it should be cleaned up in backup RE
          3. Backup RE should be able to adjust itself to the Unicast Routing changes 
          4. Config changes should be reflected in backup RE's control state

   RESULT:
        PASS.


3.4 CLI Output testing 
   GOAL: Testing the CLI outputs in master and backup during and after failovers 
   STEPS: 
          1. In topology above, pump traffic from source and send joins from receiver.

          2. Check for ouput consistency of following in both master and backup 
                     cli>show pim join extensive 
                     cli>show pim neighbors 
                     cli>show pim interfaces
                     cli>show pim rps 
                     cli>show pim bootstrap 

                     cli>show multicast route extensive
                     cli>show multicast rpf 
                     cli>show multicast statistics 

          3. Trigger switchovers in E and G 
          4. Check for ouput consistency of above listed CLI in both master and backup 

          5. Repeat Steps 3 and 4 multiple times.

          6. Repeat the above steps with IPv4 alone set of interfaces. 
          7. Repeat the above steps with IPv6 alone set of interfaces. 
          8. Repeat the above steps with IPv4 and IPv6 set of interfaces. 


   CRITERIA:
          1. The CLI outputs in master and backup should be consistent. 
          2. The statistics output in backup should be zero. 
                  ie., Backup should not process packets. 
          3. Check for RP information in CLI in master and backup. They should be consistent.
          4. There should not be any rpd crash. 

   RESULT:
        PASS.


3.5 RP-Set Information 

   GOAL: Testing the RP set information replication
   STEPS: 
    3.5.1 Static RP
           In topology above, configure static RP with router I as the local RP.
    3.5.2 AutoRP  
           AutoRP is not supported for IPv6.   
    3.5.3 BSR  
           In topology above, configure BSR RP with router I as the candidate RP.
                router E and router I as candidate BSRs.
    3.5.4 Embedded RP  
           In topology above, configure Embedded RP with local RP on I. 

    For the above three RPs, check the below. 

          1. Check for RP set information in both master and backup 
                     cli>show pim rps 
                     cli>show pim bootstrap 

          2. Trigger switchovers in E and G 
          3. Check for ouput consistency of above listed CLI in both master and backup 

          4. Repeat Steps 3 and 4 multiple times.

          5. Repeat the above steps with IPv4 alone set of interfaces. 
          6. Repeat the above steps with IPv6 alone set of interfaces. 
          7. Repeat the above steps with IPv4 and IPv6 set of interfaces. 


   CRITERIA:
          1. The CLI outputs in master and backup should be consistent. 
          2. Check for RP information in CLI in master and backup. They should be consistent.
          3. There should not be any rpd crash. 

   RESULT:
        PASS.


3.6 Please execute the tests listed below in conjuction with 3.1, 3.2 and 3.3 
      3.6.1 Neighbor state maintenance. 
            Please validate that neighbors state information is synced and appropriate hello timers are running on backup RE 
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.2 Dense mode SG state
            Please validate that SG state information is synced and appropriate Join/Prune timers are running on backup RE 
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.3 SSM mode SG state
            Please validate that SG state information is synced and appropriate Join/Prune timers are running on backup RE 
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.4 Sparse mode SG state
            Please validate that SG state information is synced and appropriate Join/Prune timers are running on backup RE 
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.5 Register state Machine
            Please note that as of RLI 9022, Register state will not be replicated to backup RE.
            This functionality will be addressed in RLI 6259. 

            However, if Source starts first and there are no Joins downstream, the backup RE will not have information on the source.
            After failover, when the next NULL register comes, the new master will have the information about source. 
            If during the switchover, Joins come downstream, traffic will be stalled until next NULL Register is received.
            The traffic loss should be restricted only to this window.

                RESULT: PASS

      3.6.6 MC module testing 
            Please validate that Mcast route information is synced and appropriate mroute timers are running on backup RE 
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.7 Generic Mirror Testing
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.8 Config Mismatch Testing
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

      3.6.9 Free Form Testing
            Please validate 3.3 (which in turn checks 3.1 and 3.2)  
                RESULT: PASS

4. Local Recevier Testing

   GOAL: Testing the functionality of MLD in NSR mode 
   STEPS: 
      1. Configure NSR and pump MLD Joins downstream 
      2. With above, please validate 3.3 
      3. Configuer static MLD joins 
      4. With above, please validate 3.3 

   CRITERIA:
          1. The Joins should be replicated to the backup RE and 3.3 should pass 

   RESULT:
        PASS.

5. RPD restarts

   GOAL: Testing the behavior of rpd restart on master and backup RE  

   STEPS: 
      1. With a stable NSR setup passing 3.3 test case, restart rpd on the master 
      2. With a stable NSR setup passing 3.3 test case, restart rpd on the backup 

   CRITERIA:
          1. Master rpd should come up again and system should get to stable state similar to non-NSR behavior 
          2. Backup rpd should come up again and the Initial State replication should occur 
          3. System should get to stable state similar to non-NSR behavior 

   RESULT:
        PASS.

6.  ISSU Testing

   GOAL: Testing the ISSU module with PIM NSR for IPv6 

   STEPS: 
      1. Configure NSR and perform ISSU 
      2. Check for cli>show task replication output.
           It should appropriately move from Init->InProcess->Complete
      3. Have a highly scaled setup. While the Initial State Replication is in process, perform an ISSU.

   CRITERIA:
          1. ISSU with PIM NSR should go through without being aborted. 
          2. CLI output of "show task replication"  should appropriately move from Init->InProcess->Complete
          2. During an ISSU at Initial State replication, the backup should bail out without abort or crashes. 
 
   RESULT:
        PASS.
           

7. Scaling Test

   GOAL: Testing and Quantifying the numbers for PIM NSR v6 

   STEPS: 
      1. Configure NSR with IPv6
      2. Configure different RPs for a set of multicast groups 
      3. Pump Joins for a large number of groups 
      4. Pump Traffic at a very high rate for all these groups. 
      5. Pump Prunes for a large number of groups 
      6. Measure the performance and benchmark it with behavior of non-NSR 
      7. Measure the performance and benchmark it with behavior of NSR but PIM NSR disabled
      8. Perform multiple failovers and validate Section 3.3 
      9. Perform Unicast routing changes config changes and validate Section 3.3 

   CRITERIA:
          1. Scaling tests should pass without RPD crashes and traffic loss  
          2. Section 3.3 should be validated for different control plane info and data traffic loss
    
   RESULT:
        PASS. 
        Have seen/fixed a few PRs (crashes) raised by systest with high scaling numbers with PIM NSR for IPv6 turned on. 
        However, to be certified by the Scaling Team 


8.  REGRESSION TEST CASES

Rerun pim regression tests.

9.  INTEROP TEST CASES

None.

10. MIGRATION & COMPATIBILITY TEST CASES

None.  new configuration syntax.

11. TEST COVERAGE REMAINING

12. DEFECTS REMAINING

None.

13. Review Tracker
