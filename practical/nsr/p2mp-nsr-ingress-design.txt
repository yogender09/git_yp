$Header: /cvs/juniper/sw-projects/os/nsr/p2mp-nsr-ingress-design.txt,v 1.1 2011/02/28 20:17:22 mjork Exp $

Process Template J3.02.P05.T03S


	  NSR for RSVP P2MP Ingress Design Specification

		   Markus Jork <mjork@juniper.net>

Copyright (C) 2011, Juniper Networks, Inc.
Template Owner:  Waldek Mikolajczyk
Template Version 1.4

NOTICE: This document contains proprietary and confidential
information of Juniper Networks, Inc. and must not be distributed
outside of the company without the permission of Juniper Networks
engineering.



TABLE OF CONTENTS

1.	INTRODUCTION
1.1	SCOPE
1.2	REVISION HISTORY
1.3	REFERENCED DOCUMENTS
1.4	GLOSSARY
2.	ARCHITECTURE OVERVIEW
2.1	DESIGN REQUIREMENTS
3.	DESIGN DETAILS
3.1	ASSUMPTIONS AND DEPENDENCIES
3.2	HIGH LEVEL DESIGN
3.3	DESIGN RISK ITEMS
3.4	IMPACTED SOFTWARE COMPONENTS
3.4.1	SOFTWARE COMPONENTS IMPACTED BY DESIGN
3.4.2	POTENTIALLY IMPACTED SOFTWARE COMPONENTS
3.5	COMPONENT INTERACTIONS
3.5.1	COMPONENT X
3.5.1.1	COMPONENT DEFINITION
3.5.1.2	LIST OF CHANGES
3.6	INTER PROCESS COMMUNICATION
3.7	CONCURRENCY STRATEGY
3.8	STARTUP STRATEGY
3.9	MEMORY MANAGEMENT
3.10	FAULT AND EXCEPTION HANDLING
3.11	DEBUG SUPPORT
3.12	TESTABILITY, SERVICEABILITY AND DIAGNOSE-ABILITY
3.13	CONSTRAINTS AND LIMITATIONS
3.14	REJECTED DESIGN ALTERNATIVES
3.15	CONSTRAINTS AND LIMITATIONS
4.	PATENT OPPORTUNITIES
5.	PERFORMANCE
5.1	PERFORMANCE RELATED RESOURCES
5.2	TARGET PERFORMANCE
5.3	64-BIT KERNEL SUPPORT
6.	SCALING
7.	MULTI-CORE ENVIRONMENT
8.	COMPATIBILITY ISSUES
9.	HIGH AVAILABILITY (HA)
9.1	GRACEFUL RE SWITCHOVER (GRES), ISSU IMPACT
9.2	NSR IMPACT
10.	LOGICAL SYSTEM / ROUTING INSTANCE IMPACT
11.	MULTI / VIRTUAL CHASSIS IMPACT (HOBSON OR CHAI)
12.	PLATFORMS SUPPORTED
13.	SDK IMPACT
13.1	SDK CUSTOMER USAGE
14.	JUNOS READY SOFTWARE CONSIDERATIONS
15.	FREE SOFTWARE CONSIDERATIONS
16.	3RD PARTY SOFTWARE CONSIDERATIONS
16.1	FUNCTIONAL ROLE OF 3RD PARTY CODE WITHIN JUNOS
16.2	INTEGRATION DETAILS OF 3RD PARTY CODE WITHIN JUNOS
17.	POSIX NON-COMPLIANCE
18.	FUTURE CONSIDERATIONS
19.	REVIEW COMMENTS
19.1	REVIEW STAKEHOLDER MATRIX




1. INTRODUCTION

This document provides an overview of the planned code changes to
implement RLI 12173: NSR support for P2MP LSPs on the ingress router.


1.1 SCOPE

No major additions or changes to existing code are expected. The rpd
code needs to be changed and augmented in various places to enable NSR
support on the ingress router for a P2MP LSP. Support for P2P ingress
NSR as well as P2MP transit/egress is already present in the system.


1.2 REVISION HISTORY

Rev. 1.0	02/28/2011	mjork	initial revision


1.3 REFERENCED DOCUMENTS

Functional specification: 
 http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/p2mp-nsr-ingress-funcspec.txt


1.4 GLOSSARY



2. ARCHITECTURE OVERVIEW

No major architectural changes are needed. This is an extension of the
existing support for P2P ingress NSR and P2MP transit/egress NSR.


2.1 DESIGN REQUIREMENTS



3. DESIGN DETAILS

3.1 ASSUMPTIONS AND DEPENDENCIES

It is assumed that NSR support for P2P LSPs at the ingress is working
as documented.



3.2 HIGH LEVEL DESIGN

The intention is to only make small code changes to extend the
existing functinality.


3.3 DESIGN RISK ITEMS

Due to the large number of configuration options for LSPs and their
possible permutations, it is impossible to forsee, evaluate, or test
all scenarios in which the software will be used.


3.4 IMPACTED SOFTWARE COMPONENTS

3.4.1 SOFTWARE COMPONENTS IMPACTED BY DESIGN

The changes are restricted to rpd, specifically the rsvp, tag, and CCC
code modules as well as some infrastructure code.


3.4.2 POTENTIALLY IMPACTED SOFTWARE COMPONENTS

A new TLV might be sent to the kernel for VT IFLs used by rsvp. The
contents will be opaque to the kernel and will be used by rsvp on the
backup RE (or during graceful restart).

If any problems are detected in the interaction of P2MP RSVP with MVPN
or VPLS when NSR is enabled, some fixes might be needed in the TAI
code that glues these components together.


3.5 COMPONENT INTERACTIONS

3.5.1 RSVP COMPONENT

3.5.1.1 COMPONENT DEFINITION

This is the existing "rsvp" task in rpd.


3.5.1.2 LIST OF CHANGES

A) Replication of Ingress PSBs

The mpls and rsvp code has fine-grained control over what kind of
state needs to be mirrored to the backup RE. This is controlled via
NSR feature flags in tag.h. The decision whether to replicate a PSB is
based on:

- session is P2P or P2MP
- router is ingress, transit, or egress
- LSP is dynamically created or statically configured
- LSP is used for CCC
- it is a non-packet GMPLS LSP
- it is a backup LSP (for local protection)
- it is a bypass tunnel

As part of this project, replication of P2MP ingress PSBs will now be
enabled.  We will also enable the replication of CCC PSBs at the
ingress, for both P2P and P2MP. Until now, CCC was not supported even
in the P2P case.

B) Synchronize VT Interface Use Between Master and Backup

On the backup, rsvp will no longer allocate vt interfaces on its
own. Instead, it needs to learn the allocated interfaces from the
master. This can be done by listening to ifl changes from the kernel
and by listening to the interface replication messages from the master
rsvp instance. These two information sources need to be reconciled.

Any requests to create a dynamic vt interface on the backup will no
longer result in a request to the kernel to allocate an ifl.

The backup needs to know which of the vt interfaces it learns from the
kernel is the default vt on the master. The default vt and the dynamic
vt's are handled differently. The latter have a ref count to keep
track of their usage and delete them if appropriate. So to keep master
and backup synchronized, the master rsvp instance will indicate the
default vt by including a new TLV along with the ifl creation request
to the kernel. This TLV also needs to be taken into consideration
during GR.


C) Link-Protection

When the RSVP code on the backup RE creates the link-protection
nexthop gateway (used to send traffic over the bypass in case of link
failure), it needs to match exactly what the kernel has replicated
from the master RE. There is currently a problem where the address family
of the gateways do not match. This needs to be resolved.

During failover, it needs to be checked that the path taken by the
bypass tunnels is still valid. A CSPF needs to be scheduled in retrace
mode to check this. It seems that this is not actually happening
today. Retracing is only done for PVCs maintained in the tag code but
not bypass LSP which are mainainted by rsvp. This appears to be a bug
in the existing P2P NSR functionality.


3.5.2 MPLS COMPONENT

3.5.2.1 COMPONENT DEFINITION

This is the existing "mpls" task (implemented in the "tag" directory)
in rpd.


3.5.2.2 LIST OF CHANGES

A)
Make sure MIB code works correctly on the backup and handles the
failover to becoming master.

B)
The tag_p2mp_pvc structure represents the P2MP LSP tree on the ingress
router. It points to a set of branch tag_pvc structures (representing
the sub-LSPs). The replication of the tag_pvc's is already handled by
the existing P2P NSR code. However, now the p2mp_branch_id field of
the tag_pvc becomes of interest. Our implementation uses it in much
the same way as the src_port value for P2P LSPs. So on first glance it
would make sense to replicate the p2mp_branch_id just like we already
to the src_port. However, in practice the replicated src_port isn't
really used on the backup RE because the value can be recovered from
the replicated PSB. The same is true for the p2mp_branch_id.

The tag_p2mp_pvc is not currently replicated. But it has several
fields that need to be synced between master and standby RE:

- p2mp_pvc_id is allocated on the master, has to be replicated to backup.
- p2mp_pvc_index is computed from p2p_pvc_id, no need to replicate.
- p2mp_dstport is allocated on the master, has to be replicated to backup.
- p2mp_branch_id is just used to find the next unused branch id to allocate
  for a branch pvc. It can be set to a reasonable value during failover and
  does not need to be replicated.
- p2mp_srcport is similar to p2mp_branch_id and just an allocaton aid for
  branch pvc's. It can be set to a reasonable value during failover and
  does not need to be replicated.

So the only values that really need replication are p2mp_pvc_id and
p2mp_dstport. Instead of creating an entirely new replication object,
we can piggy-back these on the existing pvc replication message. Each
P2MP branch pvc will send along the p2mp_pvc_id and p2mp_dstport from
its parent tag_p2mp_pvc.

C)
Implement retrace mode for P2MP LSPs.
For no-cspf sub-LSPs, check that the ERO is valid according to current
configuration settings.



3.5.3 CCC COMPONENT

3.5.3.1 COMPONENT DEFINITION

This is the existing CCC code which runs as part of the rsvp and mpls
tasks. The source code is also distributed between the rsvp and tag
directory.


3.5.3.2 LIST OF CHANGES

A)
No kernel status update requests must be sent by the backup RE. After
switchover, this needs to be enabled again. The fix for PR 569158
already addresses this in a simplistic and not very efficient
manner. This needs to be revisited and done in a cleaner way.

B)
As mentioned in 3.5.1.2 A, the replication of PSBs used for CCC will
now be enabled. This allows ingress CCC to work with NSR.

C)
With CCC on the egress router, there will be two routes (each with
their own flood nexthop) in rpd: one from rsvp and one from CCC. The
latter has a higher preference and will be installed in the
kernel. This means that when the backup RE comes up after the master
has already established the P2MP LSP, it will not learn the rsvp route
(and thus its flood nexthop) from the kernel. Unlike changes to a
flood nexthop (which the backup picks up by listening to NH CHANGE
messages from the kernel), Learning about new flood nexthops is
currently only triggered by route add events and at rpd startup by
reading all the routes from the kernel. This needs to be changed so
that the backup rpd will learn about the rsvp flood nexthop which
exists without a route. Otherwise it will be forgotten and leaked in
the kernel.


3.6 INTER PROCESS COMMUNICATION

No new mechanisms or messages will be introduced.


3.7 CONCURRENCY STRATEGY

There are no changes from the current rpd and NSR design. There is no
actual concurrency within rpd. Rpd and the kernel replicate their
respective state from master to backup RE independently and
concurrently. Rpd on the backup RE communicates with the kernel via
the routing socket to learn about the kernel state and reconcile it
with the rpd state.


3.8 STARTUP STRATEGY
n/a

3.9 MEMORY MANAGEMENT

No changes from existing design.


3.10 FAULT AND EXCEPTION HANDLING

Following the existing design, rpd will just crash and burn if
anything goes wrong. To make this even more likely, I may sprinkle
some new assert() statements throughout the code.

If the system is configured to perform a NSR failover when rpd fails,
this will happen and rpd on the backup RE takes over. If NSR is not
configured to be triggered by a rpd failure, rpd will just restart and
traffic loss will occur.


3.11 DEBUG SUPPORT

The hidden "show mpls replication ..." commands will be enhanced to
show all of the replicated data, including the new P2MP-related values.

A new hidden command will be introduced to display the vt interface
usage of rsvp. It can be used on both master and backup RE. The
command will display all vt ifd's and their default vt ifl. It will
also display all dynamically allocated vt ifl's and their reference
counts.

A debug shell command (tag_p2mp_dbg_show_pvc) will be added to display
the contents of the p2mp-related data structures in the tag
code. Given the P2MP LSP name, the contents of tag_p2mp_pvc, its list
of tag_pvc branches including their tag_path will be dumped to the
debug shell. The debug shell is not available on production systems,
so this debug feature is meant for internal, in-house Juniper use
only.


3.12 TESTABILITY, SERVICEABILITY AND DIAGNOSE-ABILITY


3.13 CONSTRAINTS AND LIMITATIONS

This is discussed in the functional spec.


3.14 REJECTED DESIGN ALTERNATIVES



4. PATENT OPPORTUNITIES

Patent opportunities are not expected.



5. PERFORMANCE

See functional spec.


5.1 PERFORMANCE RELATED RESOURCES


5.2 TARGET PERFORMANCE


5.3 64-BIT KERNEL SUPPORT
n/a



6. SCALING



7. MULTI-CORE ENVIRONMENT
n/a


8. COMPATIBILITY ISSUES



9. HIGH AVAILABILITY (HA)

See functional spec.

9.1 GRACEFUL RE SWITCHOVER (GRES), ISSU IMPACT

9.2 NSR IMPACT



10. LOGICAL SYSTEM / ROUTING INSTANCE IMPACT

NSR is not supported for logical systems.



11. Multi / Virtual Chassis Impact (Hobson or Chai)

This feature adds NSR support. That should transparently include
support for virtual chassis, too. No explicit changes will be made for
the virtual chassis environment and this will not be tested during
development and unit test. It is assumed that this just works.



12. PLATFORMS SUPPORTED

This feature is platform independent. However, as of Junos 11.3,
support for "Fast MBB" has been added to the kernel & PFE by RLI
11362. This feature is specific to T-series routers. Due to changes in
how flood nexthop changes are reported by the kernel on the backup RE,
a different code path will be executed in rpd. Thus testing of P2MP
NSR (ingress as well as transit/egress) should be done on both,
T-series and non T-series routers to catch any problems due to
platform-dependent kernel behavior.



13. SDK IMPACT
n/a


13.1 SDK CUSTOMER USAGE
n/a



14. JUNOS READY SOFTWARE CONSIDERATIONS
n/a



15. FREE SOFTWARE CONSIDERATIONS

No new free software will be included. The feature will be implemented
only through changes to existing code.



16. 3RD PARTY SOFTWARE CONSIDERATIONS

No new 3rd party code will be used.



17. POSIX NON-COMPLIANCE
n/a



18. FUTURE CONSIDERATIONS

Handling of active link-protection during NSR failover could be a lot
better.

Once MVPN supports NSR, it needs to be tested with P2MP LSPs and
changes to the ingress P2MP NSR implementation may be needed.

Support for VPLS NSR needs to be added.



19. REVIEW COMMENTS

The audit trail of the RLI tracking PR 588341 will be used to record
review comments:
https://gnats.juniper.net/web/default/588341


19.1 REVIEW STAKEHOLDER MATRIX

Function			Name			Required?	Approval State
---------------------------------------------------------------------------------------------------------------
SW1 (rpd rsvp)			Ravi Torvi		Yes		Approved/Rejected/Approved with actions
SW2 (rpd infra)			Yi Zheng		Optional	Approved/Rejected/Approved with actions
SW3 (rpd ccc)			Ambrose Kwong		Optional	Approved/Rejected/Approved with actions
SW Manager			Harish Sitaraman	Yes		Approved/Rejected/Approved with actions
JAB							No		n/a
HW							No		n/a
---------------------------------------------------------------------------------------------------------------




© Copyright 2011 Juniper Networks, Inc. -- Proprietary and Confidential –
Do not distribute outside of the company without the permission of Juniper Networks engineering
Printed copies are for reference only!