$Id: igmp-nsr-funcspec.txt,v 1.7 2007/06/26 17:51:12 ravis Exp $ tag: 

S3.02.P05.T01

                        NSR: IGMP stateful replication
                        Functional Specification

                        Ravi Singh <ravis@juniper.net>

Copyright (C) 2007, Juniper Networks, Inc.

NOTICE: This document contains proprietary and confidential
information of Juniper Networks, Inc. and must not be distributed
outside of the company without the permission of Juniper Networks
engineering.


1.  INTRODUCTION

*IMPORTANT*: The name of this RLI is a bit of a misnomer in that no IGMP 
state will be replicated between the 2 REs. However, for PIM NSR to work, IGMP
should be able to work with the scheme used for PIM NSR, as PIM relies on IGMP 
to maintain its state correctly, across failovers.

IGMP serves to provide information about multicast groups that have local 
listeners. It by itself does not provide much value in a network, except when
used as a helper protocol to a multicast routing protocol.

PIM relies on IGMP information being available. NSR for PIM would rely on
stateful replication. NSR for PIM does not necessarily need stateful
replication for IGMP state. Instead prior to failover, the PIM SG state built
on the backup (From state received from the master), shall maintain an
efficient data structure such that its walk shall provide the list of 
interfaces on which PIM considers local receiver state to be present.

After a failover, the new master RE shall eventually timeout the 
local-receiver state maintained on the (s,g)s unless IGMP, in the interim, 
re-instantiates the local-receiver state for the relevant oif for an (s,g).

On a backup RE, IGMP does not externally run. No IGMP packets are sent from 
or received by the rpd on the backup. The master rpd does not specifically 
replicate any IGMP state to the backup rpd.

The implementation of changes to IGMP so that PIM NSR works correctly, is
tracked under:
        RLI 2727, PR 94594

PIM NSR is tracked under:
        RLI 2728, PR 94595

2.  FUNCTIONALITY
2.1 Goals
    - To make IGMP changes to ensure that PIM NSR works correctly.
      Specifically, that post-failover, IGMP take appropriate action such that:
         + PIM times out local receiver state (in the PIM (sg)s) for those
           groups for which such state no longer exists after the failover.
         + PIM would create local receiver state, expeditiously, for those 
           groups for which local receiver state now exists.

2.2 Non-goals
    -  It is not an aim to support any IGMP functionality or deployment
       situation other that what is needed for PIM NSR to work correctly 
       with the IGMP functionality supported as on the time of writing this FS.
    -  It is not an aim to replicate any IGMP state.

2.3 CLI:
No changes shall be made to IGMP CLI.
The output of the various CLI commands on the backup shall not display any
relevant state as the backup does not run IGMP.
The output of the IGMP show commands on the backup should be ignored.

3.  CAVEATS
    - Backup RE does not send any IGMP packets & nor does it receive any IGMP
      packets.
    - Backup RE does not maintain IGMP statistics. IGMP statistics on the
      backup would be irrelevant.
    - No IGMP state is specifically replicated from the master RE to the 
      backup RE.
    - This document describes only the changes needed to make IGMP work
      harmoniously with the PIM NSR scheme.
    - The document does not address any requirements for IGMP NSR for other
      IGMP features or IGMP requirements per-se.

4.  OTHER REQUIREMENTS
None.

5.  IMPLEMENTATION DETAILS

On a single RE non-NSR router, PIM state does not create any IGMP state.

On the backup RE IGMP does not send any control packets & nor does it receive
any control packets. As a result, IGMP on the backup maintains no state about
group memberships.

Post-switchover, the new master shall start to run IGMP on its locally
configured interfaces just as it would have started to run on a single-RE 
router where IGMP were just enabled (due to a multicast routing protocol 
being configured).

After failover, the backup shall start the usual IGMP processing just as it
would on a router that just started to run IGMP. On failover, the 
previously-backup RE would startup as a querier and add (and eventually 
delete/time-out) groups on a per interface basis depending on the 
Reports/Leaves that it hears on the wire as per normal IGMP protocol. 

While the preceding is not new functionality in IGMP, changes shall be needed 
to start IGMP on the new master after failover. Likewise, on a backup
RE (or when a master RE transitions to backup), changes shall need to be made
to stop running the normal IGMP state machines & to stop receiving IGMP 
packets on the IGMP task socket.

6.  PERFORMANCE

No effect on performance is anticipated.

7.  COMPATIBILITY ISSUES

N/A

8.  SECURITY ISSUES

N/A

9.  Graceful RE Switchover (GRES), Hobson Impact

N/A.

10.  SDK Impact

N/A

11.  NOTES


12.  GLOSSARY
IGMP:   Internet Group Management Protocol
RE:     Routing Engine
NSR:    Non Stop Routing

13.  REFERENCES

[NSR]           Non-Stop Routing (NSR) - Functional specification
                sw-projects/os/nsr/software_spec_3083.txt
[PIM-NSR]       NSR: PIM stateful replication   
                sw-projects/os/nsr/pim-nsr-funcspec.txt
[NSR-BGP]       BGP non-stop routing (RLI 2711)
                sw-projects/os/nsr/bgp_software_spec.txt
[LDP-IMP]       Design and Implementation specification for LDP support of NSR
                sw-projects/os/nsr/ldp-nsr-implementation.txt

14.  REVIEW COMMENTS

The following are review comments that pertain to the previously proposed
approach for IGMP NSR. These are left here to provide historical perspective.

As a follow-up on email exchanges with Andy Fuelleman and Jeffrey Zhang, we 
met on Fri 6/22 to discuss some issues with the documented approach for 
IGMP NSR.

The concerns expressed were:
 1. IGMP NSR FS was written with the current state of the code in mind -
    ie on a JunOS  router, IGMP by itself serves no purpose. It has to be 
    configured with PIM (or another mcast routing protocol). This was thought
    to be restrictive for other IGMP projects in the works.
 2. State generation in IGMP by PIM: the concern expressed was that this was 
    counter to the normal direction of state generation ie from IGMP to PIM.
 3. Multiple IGMP RLIs at the same time: IGMP code would undergo changes due 
    to NSR while it was also undergoing changes due to dynamic interface 
    support for IGMP (RLI 4606). This induces scope for contention.
    
Exploring the above concerns:
 1. It is reasonable to make changes to IGMP for NSR only considering the
    functionality that already exists in IGMP as of the date of this FS. 
    However, at the same time the chosen approach must not make things
    complicated for other IGMP functionality that is known to be following in 
    later releases. It is NOW known that IGMP dynamic interface support (RLI 
    4606) shall be making extensive changes to IGMP. Also, there shall be a 
    need to have NSR support for RLI 4606 at some point of time. The current 
    approach chosen for IGMP NSR would make things complicated for NSR for 
    RLI 4606, whenever it is attempted.
 2. While normally the direction of state generation is from IGMP->PIM, it is 
    NOT an unacceptable solution to ALSO have state being generated in the 
    PIM->IGMP direction for NSR, since that reduces implementation burden 
    without beig inefficient. With the currently documented approach, this 
    direction of information flow on the backup RE (prior to switchover) would 
    have reduced implementation complexity.
 3. This is a genuine concern and it needs to be addressed. Until now it was 
    not known that another RLI in the 9.0 timeframe would be making changes to 
    IGMP.

PIM NSR requirement from IGMP: The changes for IGMP NSR were needed for PIM on
a new-master to correctly delete local-receiver state for those groups with 
PIM (s,g) state for which the new-master did not get any report (after it sent 
its general query soon after switchover) within a certain time-frame.

Summary of changes to be made to the IGMP NSR approach:
Given the above concerns 1 & 3, this approach for IGMP NSR needs change.
The PIM NSR requirement from IGMP still stands. Thus, to meet PIM's
requirement and also address the IGMP NSR concerns, the following shall be 
done:
  - On the backup, instead of population the _group_nodes & mgm_ifs in IGMP,
    PIM shall maintain auxiliary state on the SGs on the backup that will help
    it track the groups that have local receivers in a walkable data
    structure.
  - After switchover, a timer shall be initiated in PIM on the new master to
    timeout the above loca-receiver PIM (s,g) state unless IGMP in the interim
    explicity provides a call-back with information about the group still
    having local receivers on the given interface.

