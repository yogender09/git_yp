$Id: l3vpn-funcspec.txt,v 1.8 2008/01/08 22:30:52 rex Exp $

            NSR: pre-release testing of L3VPN stateful replication

                                   RLI 3170
  
                             Functional Specification

Author: Bruno Rijsman <brijsman@juniper.net> 

Copyright (C) 2006, Juniper Networks, Inc.

NOTICE: This document contains proprietary and confidential information of 
Juniper Networks, Inc. and must not be distributed outside of the company 
without the permission of Juniper Networks engineering.

1. INTRODUCTION

This document contains the functional specification for the "NSR: prerelease 
testing of L3VPN stateful replication" feature.

Traceability information

    Target product        : JUNOS
    Target JUNOS release  : 9.2R1
    RLI                   : 3170
    Tracking PR           : 73184

Referenced RLIs

    RLI 2711
    NSR: BGP stateful replication for IPv4 and IPv6 (infrastructure-only)

    RLI 3164
    NSR: Stateful ISIS & BGP  @ scale & performance (TRD)

    RLI 3165
    NSR: Stateful OSPF&OSPFv3 & BGP @ scale & performance (TRD) 

    RLI 3169
    NSR: prerelease testing of L2VPN stateful replication 

    RLI 2720
    NSR: MPLS and RSVP stateful replication for ingress and egress 

    RLI 3167
    NSR: RSVP stateful replication for transit 

    RLI 4207
    NSR: L3VPN testing with RSVP 

    RLI 2728
    NSR: PIM stateful replication     

    RLI 2723
    NSR: L3VPN stateful replication for IPv4 and IPv6

Referenced documents

    [NSR-BASE]
    Non-Stop Routing (NSR)
    Functional Specification
    sw-projects/os/nsr/software_spec.txt

    [BGP-NSR]
    BGP non-stop routing (RLI 2711)
    Software Specification
    sw-projects/os/nsr/bgp_software_spec.txt

    [BGP-SR]
    BGP stateful replication
    Functional Specification
    sw-projects/os/nsr/bgp-design.txt

    [L2VPN-VPLS-FS]
    NSR support for L2VPN and VPLS
    Functional Specification
    sw-projects/os/nsr/l2vpn-vpls-funcspec.txt    

    [L2VPN-VPLS-DESIGN]
    NSR support for L2VPN and VPLS
    Design Specification
    sw-projects/os/nsr/l2vpn-vpls-design.txt    

    [MPLS-NSR-ISSUES]
    MPLS issues for NSR
    sw-projects/os/nsr/mpls-common-issues.txt
    
2. FUNCTIONALITY

2.1. Introduction

When Pedro Marques implemented NSR support for BGP (see [BGP-NSR] and [BGP-SR])
he also implemented -but never tested- NSR support for many L3VPN 
features. The goal of this RLI is to test these L3VPN features for which NSR 
support has already been implemented (see section 2.2 for a list of these 
features).

There are also some L3VPN features for which NSR support has not yet been 
implemented (see section 2.3 for a list of unsupported features). This RLI 
does not add support for those missing features; the only new code will be 
fixes for bugs found during unit testing of the existing code.

NSR support for L2VPNs and VPLS is covered by a separate RLI 3169 (see 
[L2VPN-VPLS-FS] and [L2VPN-VPLS-DESIGN]).

This RLI is a "pre-release testing RLI". There is a follow-up RLI scheduled
for customer-visible NSR support for L3VPN (RLI 2723).

2.2. L3VPN features which support NSR

The following L3VPN features are already supported by the existing code and 
will be tested as part of this RLI:

- IPv4 VPN-unicast routes (ingress or egress)

- IPv6 VPN-unicast routes (ingress or egress)

- IPv4 labeled-unicast routes (ingress or egress)

- IPv6 labeled-unicast routes (ingress or egress)

- Import (vrf-import)

- Export (vrf-export)

- Vrf-target

- Overlapping VPNs

- Multiple CEs per VRF

- Multiple routes per CE

- Per-prefix-label

- Auto export

- Inter-AS option A
- Inter-AS option B
- Inter-AS option C
- Carrier supporting carriers

- Route target filtering

- VRF-table label (*)

- Label aggregation based on site-of-origin (SOO) community

- VPN route-reflectors (without next-hop-self)

- LDP base tunnels

- Independent domains

- Automatic route distinguishers (RDs)

- Hub-and-spoke topologies using no-vrf-advertise

- L3VPNs over dynamic GRE base tunnels

- The following PE-CE routing protocols:
  - RIP
  - RIPng
  - OSPF
  - OSPFv3
  - IPv4 static routes
  - IPv6 static routes
  - IPv4 EBGP (unique AS per CE)
  - IPv6 EBGP (unique AS per CE)
  - IPv4 EBGP (same AS per CE + as-override)
  - IPv6 EBGP (same AS per CE + as-override)
  - IPv4 IBGP
  - IPv6 IBGP
  - IPv4 IBGP + independent-domain
  - IPv6 IBGP + independent-domain

- Multipath (see also section 11.2)

(*) There is a known issue with VRF-table label: the LSI interface is
not created on the standby RE. This will be fixed as part of this RLI.

Although 6PE is technically not a L3VPN feature, it is supported by the
existing code and will be tested as part of this RLI.

2.3. L3VPN features which do not yet support NSR

The following L3VPN features do not yet support NSR in the sense that there 
may be temporary traffic loss and/or route flaps when a switch-over from the 
master RE to the standby RE occurs.

2.3.2. RSVP base tunnels are not yet supported

Since RSVP does not yet support NSR, L3VPNs only support NSR if LDP is used 
to signal base LSPs. NSR support for RSVP is scheduled using RLI 2720 
(ingress and egress) and RLI 3167 (transit). Once RSVP supports NSR, it is 
expected that no code changes will be needed in BGP to support RSVP base 
LSPs. RLI 4207 is scheduled for L3VPN NSR testing with RSVP.

2.3.3. Multicast VPNs are not yet supported

Since PIM does not yet support NSR, multicast VPNs do not support NSR yet. 
NSR support for PIM is scheduled using RLI 2728. Once PIM supports NSR, it is 
expected that no code changes will be needed in BGP to support multicast 
VPNs. It has been decided that RLI 2728 must include Multicast VPN NSR 
testing (i.e. no separate RLI will be created for this).

2.3.4. Flow routes are not yet supported.

BGP flow routes do not yet support NSR.

2.3.5. Logical routers are not yet supported

Since logical routers don't yet support NSR, L3VPNs in logical routers
also don't yet support NSR. Only L3VPNs in the default logical router
are supported.

2.3.6. ORF is not supported anymore.

Since support for outbound route filtering (ORF) has been deprecated,
NSR support for ORF will not be tested.

2.4. CLI configuration

This RLI does not add any new CLI configuration statements.

A new configuration consistency check is introduced: if nonstop-routing is
configured then each VRF in a router must have a unique RD. In other words,
no two VRFs on a router can have the same RD. Note that it is still allowed
for two VRFs on different routers to have the same RD. For backwards 
compatibility, the check is only enforced when nonstop-routing is configured.
See section 5.4 for the reason behind this new restriction.

2.5. CLI commands

This RLI does not add any new CLI commands and does not change the output of 
any existing CLI commands.

The existing command "show bgp synchronization" will be unhidden.

It was agreed that it would be a good idea to have a single show command to 
report the NSR state (e.g. synchronized, synchronizing, error) for all 
protocols. This should be requested using a separate change-request PR or 
RLI.

UPDATE: As of 8.5, we do support the requested command: "show task replication"

2.6. JUNOScript

This RLI does not add any new JUNOScript commands.

2.7. J-Web

This RLI does not add any new J-Web Quick configuration screens or monitor 
screens.

2.8. SNMP

This RLI does not add or change any SNMP MIBs.

3. CAVEATS

None.

4. OTHER REQUIREMENTS

None.

5. IMPLEMENTATION DETAILS

5.1. Terminology

"Master BGP" is used to refer to BGP running on the master RE. "Standby BGP" 
is used to refer to BGP running on the standby RE. "New master BGP" is used 
to refer the BGP running of what just became the new master RE after a 
switch-over.

5.2. Overview of BGP NSR

The basic design of BGP NSR can be summarized as follows:

-    Each BGP session is replicated at the TCP layer which allows standby 
     BGP to monitor all BGP messages sent and received by master BGP.

-    Standby BGP reconstructs the RIB-in by observing the UPDATEs received 
     by master BGP.

-    Standby BGP reconstructs the RIB-out by observing the UPDATEs sent by 
     master BGP.

-    There is a session between master BGP and standby BGP which runs a 
     proprietary enhanced version of BGP. This special BGP session is used 
     for the following:
     -    Master BGP can report new BGP sessions to standby BGP.
     -    Standby BGP can report that it has initiated replication of a new 
          BGP session to master BGP, which allows the new BGP session to go 
          into state Established.
     -    Standby BGP can request master BGP to report existing BGP 
          sessions when it is out-of-sync for any reason.
     -    Master BGP can send the contents of the RIB-in and RIB-out to 
          standby BGP for BGP sessions which are out-of-sync.

-    Prior to switch-over, standby BGP:
     -    Fills the RIB-in based on the snooped BGP updates received by 
          the master.
     -    Fills the RIB-out based on the snooped BGP updates sent by 
          the master.
     -    Does not send any UPDATEs.

-    After a switch-over, standby BGP becomes the new master BGP. All TCP 
     connections stay up.

-    The new master BGP starts running the decission process: it re-computes 
     the RIB-out from the RIB-in and only sends UPDATEs if there are deltas.
     The RIB-out used to contain the updates which were actually sent, and
     now the RIB-out is replaced by what the new master BGP thinks should 
     be sent. If all is well, there should be few if any differences.

For more details on the basic design of BGP NSR see [BGP-NSR] and [BGP-SR].

5.3. Label allocation for advertised routes

There is an issue with label allocation for L3VPN routes on the standby RE. 
Using the replicated TCP sessions, the standby BGP can observe the BGP 
UPDATEs for VPN routes sent by master BGP. The standby BGP can determine the 
RD, the prefix, the label, and the BGP indirect next-hop address from the 
sent UPDATE. However, the standby BGP can not determine the direct next-hop 
to which the label should point in the mpls.0 route table. The master BGP 
might have cross-connected the label to an interface, to a VRF, to another 
label advertised by a downstream router, etc. The standby BGP has no way of 
determining what the label is cross-connected to purely from observing the 
sent UPDATE.

To address this issue the following heuristic has already been implemented 
(but never tested) for the standby BGP:

-    Standby BGP observes a VPN route with label L advertised by master BGP 
     to an upstream router.

-    Standby BGP adds the RD and prefix to the RIB-out of the appropriate 
     table (e.g. vrf-name.inet.0 or bgp.l3vpn.0) along with the label L.

-    Standby BGP also adds a route to table mpls.0 with label L and a 
     discard next-hop. Note: this mpls.0 discard route is only used as
     a "hint" in the control plane and is not installed in the forwarding
     plane until it is replaces by the "real" mpls.0 route (see below).
     This, egress forwarding is not interrupted.

-    However, standby BGP does not yet mark label L as "allocated".

-    After switch-over, standby BGP becomes the new master BGP.

-    The new master BGP starts next-hop resolution, best-route selection, 
     and applying outbound policy. It sends UPDATEs only if the RIB-out 
     changes relative to what was stored in the RIB-out while observing 
     UPDATEs sent by the old master RE.

-    As part of applying outbound policy, new master may decide that it 
     needs to allocate a label for an advertised route. 

-    The new master will try to re-use the label which the old master 
     previously advertised which is stored in the RIB-out.

-    In order to check whether it is possible the re-use the previously 
     advertised label, the new master does a lookup of the label in mpls.0 
     and compares the next-hop of the route in the RIB-out with the next-hop 
     of the route in mpls.0. There are four possible outcomes:

     1.    There is a route for label L in mpls.0 which a discard next-hop. 
           In this case, the new master re-uses label L, marks label L as 
           allocated, and changes the next-hop in mpls.0 to make it point to 
           the next-hop of the route in the RIB-out. Note that this case 
           typically occurs when the new standby BGP advertises the first 
           route with label L.

     2.    There is a route for label L in mpls.0 with a real next-hop (i.e. 
           not discard) which is equal to the next-hop of the route in the 
           RIB-out. In this case, the new BGP master re-uses the label L and 
           bumps up the ref-count of label L. Note that this case typically 
           occurs when the new standby BGP advertises more routes with label 
           L after the first one.

     3.    There is a route for label L in mpls.0 with a real next-hop (i.e. 
           not discard) which is different from the next-hop of the route in 
           the RIB-out. In this case, the new BGP master cannot re-use label 
           L. Instead the new BGP master allocates a new label L'.

     4.    There is no route for label L in mpls.0.  In this case, the new 
           BGP master cannot re-use label L. Instead the new BGP master 
           allocates a new label L'.

-    After reconvergence is complete, any remaining "hint" mpls.0 routes
     must be cleaned up.

The basic assumption behind this heuristic is that the master and the standby 
RE are reasonably close in-sync. This means that after the new master RE does 
next-hop resolution and best-route selection, for most routes it will end up 
with the same next-hop for each route as the old master used to have. This, 
in turn, means that cases 3 and 4 only occur for a small number of routes 
which are out-of-sync. Note that having a mechanism to handle out-of-sync 
routes is needed anyway because they cannot be entirely avoided.

5.4. Why each VRF on the router must have a unique RD

Currently it is allowed to configure two VRFs on a router with the same RD.
This is a problem for BGP on the standby when nonstop-routing is enabled.
The standby is observing the BGP updates advertised by the master and uses
this to create a copy of the RIB-out. For each BGP update, the standby must
determine which routing instance (VRF) the update came from. The only field
available in the BGP update for this purpose is the RD. Hence, it is 
necessary that each VRF can be uniquely identified by its RD.

5.5. Why BGP-signaled transit LSPs are not supported yet

The current BGP code does not support NSR for transit LSPs: when a switch-
over occurs from master RE to standby RE there may be temporary route flaps 
and temporary dropped traffic for BGP-signaled transit LSPs. Section 2.3.1 
lists the L3VPN features which don't support NSR as a result of this issue. 
Due to time and resource contstraints this issue will not be fixed as part of 
this RLI. 

The root cause for this issue is as follows:

-    Say that the master BGP has received a labeled route (e.g. a VPN route 
     or a labeled-unicast route) with label L1 from a downstream BGP 
     speaker.

-    The master BGP propagates that labeled route to one or more upstream 
     BGP speaker.

-    For some reason (e.g. because of implicit or explicit next-hop-self) 
     the master BGP decides to allocate a new label L2 to advertise in the 
     UPDATEs to the upstream routers.

-    The master BGP cross-connects label L2 to label L1. In other words, it 
     adds an entry in table mpls.0 for label L2 whose next-hop causes label 
     L2 to be swapped for label L1 and then to be sent to the downstream BGP 
     speaker. The way to get to the downstream BGP speaker is determined by 
     resolving the BGP indirect next-hop of the received route.

-    Here comes the key-point: the master BGP instructs the next-hop 
     resolution module in RPD to monitor the resolution of label L2. This 
     causes BGP to be informed immediately when the next-hop chain of label 
     L2 changes which allows BGP to re-run the decission process and 
     possibly to send an UPDATE to modify or withdraw the route.

There is a problem with this scheme which prevents it from working properly 
on the standby RE. As described in section 5.3, table mpls.0 on the standby 
RE contains one entry for each advertised label (including label L2) but all 
of these labels point to a discard next-hop. After switch-over it takes some 
finite amount of time to replace these discard next-hops with the real next-
hops. During this time interval, the next-hop resolution resolution module in 
BGP will think that all advertised labels are unreachable which would cause 
BGP to withdraw all labeled routes.

This issues will be fixed using a separate future RLI; it will not be fixed 
using this RLI.

6. PERFORMANCE

This RLI is a pre-release testing RLI and as such is intended to concentrate 
on functional testing rather than testing "at full scale and performance".

7. COMPATIBILITY ISSUES

None.

8. SECURITY ISSUES

None.

9. NOTES

None.

10.    GLOSSARY

BGP     Border Gateway Protocol
GRE     Generic Routing Encapsulation
ISIS    Intermediate System to Intermediate System
L2VPN   Layer-2 Virtual Private Network
L3VPN   Layer-3 Virtual Private Network
LDP     Label Distribution Protocol
MPLS    Multi-Protocol Label Switching
NSR     Non-Stop Routing
ORF     Outbound Route Filtering
OSPF    Open Shortest Path First
OSPFv3  Open Shortest Path First version 3
RD      Route Distinguisher
RE      Routing Engine
RIB     Routing Information Base
SOO     Site Of Origin
RSVP    Resource reSerVation Protocol
TCP     Transmission Control Protocol
TRD     Trade-off Requirements Document
VPLS    Virtual Private Local area network Service
VPN     Virtual Private Network
VRF     VPN Routing and Forwarding instance

11. REVIEW COMMENTS

11.1. REVIEW 31-JUL-2006

Attendees:

  Latha Vemulapalli        System test
  Nischal Sheth            Software development
  Richard Hendricks        Technical publications
  Cliff DeGuzman           System test
  Shiv Gurunathan          System test
  Steven Lin               Software development

Comments:

  1. Add: NSR for 6PE is supported.

  2. Add: NSR for flow-routes is not supported.

  3. Add: NSR for independent domains is supported.

  4. Add: NSR for ORF is not supported.

  5. There is a know issue with NSR for VRF-table labels: the LSI interface is
     not created on the standby RE. This issue must be fixed as part of this
     RLI.

  6. Check if label aggregation is the same as label allocation based on the
     SOO and if so clarify.

  7. Add: auto-RD is supported.

  8. Add: NSR for knob related to hub-and-spoke topologies (no-vrf-advertise?)
     is supported.

  9. NSR code assumes that no two VRFs in a single router have the same RD
     but this is currently not enforced. Add a new configuration check to
     make sure that each VRF on the router has a unique RD. Only enforce the
     check if NSR is enabled to make sure existing deployments are not broken.

 10. Add: NSR for VPNs over GRE base tunnels is supported (assuming NSR for
     static routes in inet.3 are supported).

 11. Note: the RLI for NSR support for PIM should include testing multicast
     VPNs (i.e. there is no plan for a separate RLI for NSR for multicast
     VPNs).

 12. Add: NSR for logical routers is not supported.

 13. Add: NSR for the following PE-CE protocols is supported: RIP, OSPF,
     BGP, static routes.

 14. The "show bgp synchronization" command should be unhidden.

 15. It would be a good idea to have a single show command to report the NSR
     state (e.g. synchronized, synchronizing, error) for all protocols. This
     should be requested using a separate change-request PR or RLI.

 16. Clarify what it means that "the decission process is not running on the
     standby BGP).

 17. Clarify why having a "hint" mpls.0 route which points to a discard
     next-hop does not affect forwarding on the egress. (no-install bit?
     phantom routes?)

 18. Describe how any remaining "hint" mpls.0 routes are cleaned up after 
     reconvergence is complete after switch-over.

 19. It was decided that NSR support for BGP-signaled transit LSPs will be
     covered by the existing RLI 2723 (i.e. there will not be a separate
     RLI for that).

 20. Check is inter-AS option b is really not yet supported (i.e. check
     if option b requires resolution state on table mpls.0).

Conclusion: approved conditional to the above changes.

11.2. E-MAIL DISCUSSION 3-AUG-2006

Attendees:

  Cliff DeGuzman           System test
  Latha Vemulapalli        System test
  Shiv Gurunathan          System test
  Steven Lin               Software development

  1. There was an exchange of e-mails about whether or not NSR is supported
     for L3VPN multipath (RLI 1955) in the current code. E-mails from Pedro 
     seemed to indicate that it was. For this RLI, we will say that multipath 
     supports NSR. If it turns out that it doesn't, we'll consider it a bug 
     and fix it as part of this RLI.


