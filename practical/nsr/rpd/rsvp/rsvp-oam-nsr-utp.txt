
                   RSVP OAM NSR Unit-Test-Plan
                   Anil Kumar G.V  (anilgv@juniper.net)
                =========================================

Copyright (C) 2010, Juniper Networks, Inc.

NOTICE: This document contains the proprietary and confidential
information of Juniper Networks, Inc., and must not be
distributed outside of the company without the
permission of Juniper Engineering.

1.  INTRODUCTION

This document describes the unit test plan for RSVP OAM NSR
functionality[1].

RLI: 6485 [2]
Tracking PR: 550749[3]
Functional spec: RSVP OAM NSR function Spec [1]

2.  SCOPE

2.1  Functional coverage

This unit test plan will cover all of the supported functionalities specified
in the functional spec of this feature [1].

2.2  Software change description

Software changes are described in the "IMPLEMENTATION DETAILS" section of
the functional spec [1]. Please refer to section 5 of the function spec for
changes in different RPD modules.


3.  SETUP

3.1 Setup A:

       +--------+     +--------+    
       |  R1(I) |-----|  R2(E) |  
       +--------+     +--------+  

       +-------+     +-------+    +-------+    
       |  R1(I)|-----|  R2   |----|  R3(E)|
       +-------+     +-------+    +-------+                                              


Summary of setup A:
o All machines have ospf, mpls and rsvp enabled on all interfaces.
o DUT machines are loaded with latest Image.

3.3 Typical config on DUT:

    system {
        commit synchronize;
    }
    chassis {
        redundancy {
            graceful-switchover;
        }
    }
    routing-options {
        nonstop-routing;
    }
    protocols {
        rsvp {
            traceoptions {
                file routing size 10m files 2;
                flag nsr-synchronization;
                flag error;
                flag event;
                flag state;
            }
            interface all;
            interface fxp0.0 {
                disable;
            }
        }
        mpls {
            traceoptions {
                file routing size 10m files 2;
                flag nsr-synchronization;
                flag nsr-synchronization-detail;
                flag error;
                flag state;
            }
            interface all;
            interface fxp0.0 {
                disable;
            }
        }
        ospf {
            traffic-engineering;
            area 0.0.0.0 {
                interface all;
                interface fxp0.0 {
                    disable;
                }
            }
        }
    }

3.4 Common ingress LSP configuration

    The following LSPs are configured between I and E for some of
    the general tests below:
    
      1. A label-switched-path with primary, secondary and secondary standby

         set protocols mpls label-switched-path LSP1 to (EGRESS) primary PATH1
         set protocols mpls label-switched-path LSP1 to (EGRESS) secondary PATH2
         set protocols mpls label-switched-path LSP1 to (EGRESS) secondary PATH3 standby

         set protocols mpls path PATH1 (EGRESS)
         set protocols mpls path PATH2 (EGRESS)
         set protocols mpls path PATH3 (EGRESS)

         set protocols mpls label-switched-path LSP2 to (EGRESS) primary PATH1 
         set protocols mpls label-switched-path LSP2 to (EGRESS) secondary PATH2 standby
         set protocols mpls label-switched-path LSP2 to (EGRESS) secondary PATH3 standby
         set protocols mpls label-switched-path LSP2 to (EGRESS) oam bfd-liveness-detection minimum-interval 2500
         set protocols mpls label-switched-path LSP2 to (EGRESS) oam bfd-liveness-detection failure-action make-before-break

         set protocols mpls label-switched-path LSP3 to (EGRESS) primary PATH1
         set protocols mpls label-switched-path LSP3 to (EGRESS) secondary PATH2 standby
         set protocols mpls label-switched-path LSP3 to (EGRESS) oam bfd-liveness-detection minimum-interval 2500
         set protocols mpls label-switched-path LSP3 to (EGRESS) oam bfd-liveness-detection failure-action teardown

         set protocols mpls label-switched-path LSP4 to (EGRESS) primary PATH1
         set protocols mpls label-switched-path LSP4 to (EGRESS) secondary PATH1 standby

         set protocols mpls label-switched-path LSP5 to (EGRESS) primary PATH1
         set protocols mpls label-switched-path LSP5 to (EGRESS) secondary PATH1 

         set protocols mpls label-switched-path LSP6 to (EGRESS) primary PATH1
         set protocols mpls label-switched-path LSP6 to (EGRESS) secondary PATH1 SELECT UNCONDITIONAL

3.5 Ingress switchover checklist

    The following checklist is used when applicable to verify that
    switchover was handled correctly for ingress LSPs.

      - Check if any LSP flapped. Wait for a few minutes to make sure
        that signaling stays up.

      - Check if CSPF and/or resignaling was triggered for any LSPs
        and why. The following commands can be useful:

        show mpls lsp extensive
        show route

      - Check age and content of routes in the routing table and make
        sure that no unnecessary changes were made.

        The command "show route age after 'n secs ago'" may be useful.

      - Check the BFD session in Master and Standby RE, both should be identical

      - Check the LSP, BFD and OAM Replication infromation in Master and Standby RE, both should be identical

      - Check the OAM Replication infromation in Primary RE and Standby RE, All should be linked.
        "show mpls replication rsvp extensive"

3.6 Egress switchover checklist

    The following checklist is used when applicable to verify that
    switchover was handled correctly for ingress LSPs.

      - Check if any LSP flapped. Wait for a few minutes to make sure
        that signaling stays up.

      - Check age and content of routes in the routing table and make
        sure that no unnecessary changes were made.

        The command "show route age after 'n secs ago'" may be useful.

      - Check the BFD session in Master and Standby RE, both should be identical

      - Check the LSP, BFD and OAM Replication infromation in Master and Standby RE, both should be identical

      - Check the OAM Replication infromation in Primary RE and Standby RE, All should be linked.
        "show mpls replication rsvp extensive"


4. FUNCTIONAL TEST CASES

4.1 Functionality related to Ingress RSVP OAM.

Goal: RSVP OAM programs BFD daemon appropriately on standby RE. 

Test Steps:
    1. Use setup A.
    2. Load all routers with default configs described in section 3.3 and 3.4
    3. Wait till the BFD session is up.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is RSVP-OAM after a while.
    2. "show mpls lsp extensive" on standby RE should
        indicate that the BFD session corresponding to LSP is up.
    3. "show task memory detail | match oam" should
        indicate that eleven mpls_mirror_oam data structure is in use on
        both primary and standby REs. 

Results: Pass


4.1.2

Goal: Disabling RSVP OAM should clean up BFD session on standby RE. 

Test Steps:
    1. Follow the steps for test 4.1.1.
    2. Unconfigure the RSVP OAM for LSP[global].

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show mpls lsp extensive" on standby RE should
        indicate that the BFD session corresponding to LSP is down.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that five mpls_mirror_oam data structures are in use on
        both REs.

Results: Pass


4.1.3

Goal: RSVP OAM programs BFD daemon appropriately on standby RE upon
      restarting rpd on standby RE. 

Test Steps:
    1. Follow the steps for test 4.1.1
    2. Wait till the BFD session on standby RE indicate that the
       client is RSVP-OAM.
    3. Restart rpd on standby RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is RSVP-OAM after a while.
    2. "show mpls lsp extensive" on standby RE should
        indicate that the BFD session corresponding to LSP is up
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that eleven mpls_mirror_oam data structure is in use.
    4. run Ingress switchover checklist
    5. Master RE should not disturb the traffic
     
Results: Pass


4.1.4

Goal: RSVP OAM programs BFD deamon appropriately on standby RE upon
      restarting rpd on master RE.

Test Steps:
    1. Follow the steps for test 4.1.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is RSVP-OAM.
    3. Restart rpd on master RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is RSVP-OAM after a while.
    2. "show mpls lsp extensive" on standby RE should
        indicate that the BFD session corresponding to LSP is up
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that eleven mpls_mirror_oam data structure is in use.

Results: Pass


4.1.5

Goal: RSVP OAM cleans up ingress BFD session on standby RE properly
      when LSP goes down. 

Test Steps:
    1. Follow the steps for test 4.1.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is RSVP-OAM.
    3. (option-1)Deactivate the LSP
    4. (option-2)Deactivate the Primary Path of LSP1
    5. (option-3)Deactivate the Primary Path and secondary standby path of LSP1
    6. (option-4)select and secondary path of LSP
    7  (option-5)Deactivate rsvp
    8. (option-6)Deactivate interface
    9. (option-7)Deactivate IGP
    10.(option-8)Offline the FPC 

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions on that LSP.
    2. "show mpls lsp extensive" on standby RE should
        not display any oam state on that particular LSP
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.

Results: Pass

4.1.6

Goal: Ingress BFD session on new master RE stay up on RE switchover.

Test Steps:
    1. Follow the steps for test 4.1.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is RSVP-OAM.
    3. Do a RE switchover.

Success Criteria:
    1. Make sure the BFD session stays up on switchover.
    2. Make sure the LSP ping state goes to up after a while.

Results: Pass  [Found some BFD issues]


4.2 Functionality related to Egress OAM

4.2.1

Goal: Egress RSVP OAM programs BFD daemon appropriately on standby RE. 

Test Steps:
    1. Use setup A.
    2. Load all routers with default configs described in section 3.3 and 3.4
    3. Wait till the egress BFD sessions for the all paths are up 

Success Criteria:
    1. On  standby RE "show bfd session detail" should indicate that
       the client is RSVP-OAM for egress BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that eleven mpls_mirror_oam data structures are in use.

Results: Pass


4.2.2

Goal: Disabling RSVP should clean up egress BFD sessions on standby RE. 

Test Steps:
    1. Follow the steps for test 4.2.1.
    2  (option-1)Deactivate rsvp
    3  (option-2)Deactivate mpls
    4. (option-3)Deactivate interface
    5. (option-4)Deactivate IGP
    6. (option-5)Offline the FPC 
Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.

Results: Pass


4.2.3

Goal: Egress RSVP OAM programs BFD daemon appropriately on standby RE upon
      restarting rpd on standby RE. 

Test Steps:
    1. Follow the steps for test 4.2.1.
    2. Restart rpd on standby RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is RSVP-OAM for egress BFD sessions after q while.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that eleven mpls_mirror_oam data structures are in use.
    4. run Egress switchover checklist
    5. Master RE should not disturb the traffic

Results: Pass


4.2.4

Goal: Egress RSVP OAM programs BFD daemon appropriately on standby RE upon
      restarting rpd on master RE. 

Test Steps:
    1. Follow the steps for test 4.2.1.
    2. Restart rpd on master RE.
    3. Wait till the egress BFD sessions are up on master RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is RSVP-OAM for egress BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that eleven mpls_mirror_oam data structures are in use.

Results: Pass


4.2.5

Goal: Egress RSVP OAM cleans up BFD sessions on standby RE properly
      when the RSVP OAM is unconfigured on ingress LSR.

Test Steps:
    1. Follow the steps for test 4.2.1.
    2. Wait till the BFD sessions on standby RE indicate that the
       client is RSVP-OAM.
    3. Unconfigure OAM on the ingress LSR.

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.

Results: Pass


4.2.6

Goal: Egress RSVP OAM BFD sessions on new master RE stay up on RE switchover.

Test Steps:
    1. Follow the steps for test 4.2.1.
    2. Do a RE switchover.

Success Criteria:
    1. Make sure the BFD sessions on the new master are still up.
    2. Make sure the BFD session stays up on switchover.

Results: Pass [Found some BFD issues]


5.  BOUNDARY TEST CASES

5.1.1

Goal: RSVP OAM links with the BFD session on standby RE even when the
      BFD session is not in the Up state.

Test Steps:
    1. Follow the steps for test 4.1.1
    2. Wait till the BFD session on standy RE indicate that the
       client is RSVP-OAM.
    3. Configure a firewall filter on Egress router that rejects BFD
       packets so that BFD session on the ingress router goes down.

       set firewall filter filter-1 term rule-1 from destination-address 81.1.1.1/32
       set firewall filter filter-1 term rule-1 then discard

    4. Do a RE switchover and wait.

Success Criteria:
    1. On the new standby RE, the BFD session which would be down should
       indicate that the client is RSVP-OAM.

Results: Pass 

5.1.2

Goal: Nonstop-routing knob Toggling .

Test Steps:
    1. Follow the steps for test 4.1.1
    2. Wait till the BFD session on standy RE indicate that the
       client is RSVP-OAM.
    3. Remove NSR and configure NSR

Success Criteria:
    1. LSP and BFD session status on primary and backup RE would be up

Results: Pass 

5.1.3

Goal: LDP over RSVP Tunneling.

Test Steps:
    1. Configure the LDP over RSVP Tunnel Topology
    2. Wait till the BFD session on standy RE indicate that the
       client is RSVP-OAM and LDP-OAM.
    3. Do a RE switchover.

Success Criteria:
    1. Make sure the BFD session stays up on switchover.
    2. Make sure the LSP ping state goes to up after a while.

Results: Pass 

6.  GRES TEST CASES


7. TX TEST CASES

There is nothing in this RLI which is specific to TX series.

8.  REGRESSION TEST CASES


9.  INTEROP TEST CASES

N/A

10.  MIGRATION & COMPATIBILITY TEST CASES

N/A

11.  TEST COVERAGE REMAINING

This unit test plan does not cover the scaling scenerio.
BFD sessions for LSPs are not stable in scaling scenerio.


6.  GRACEFUL RESTART AND GRES TEST CASES

N/A


7.  NSR AND ISSU TEST CASES

Added above

8. TX TEST CASES

There is nothing in this RLI which is specific to TX series.


9.  AGGREGATED ETHERNET/SONET TEST CASES
 
This feature is not touching the Aggregate Ethernet or Sonet area. No unit
test will be done in this area. Systest may choose to test this if necessary.


10.  REGRESSION TEST CASES       

11.  INTEROPERABILITY TEST CASES

N/A

12.  MIGRATION & COMPATIBILITY TEST CASES

N/A

13.  TEST COVERAGE REMAINING

This unit test plan does not cover the scaling scenarios.
BFD sessions for LSPs are not stable in the scaling scenarios.
  
14.  DEFECTS REMAINING

None

15. SCALING AND PERFORMANCE
 
N/A

16. STATIC ANALYSIS
 
Done

17. CODE COVERAGE

18. AUTOMATION

19. VALGRIND

The unit test automation script was also run together with ValGrind to make sure
no ValGrind errors.


21. UNIT TEST PLAN REVIEW FEEDBACK

Review feedbacks are captured automatically in the review record database.


22.  REFERENCES

[1] Anil Kumar G.V, "NSR support for RSVP OAM Functional Specification",
http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/rpd/rsvp/rsvp-oam-nsr-funcspec.txt

[2] RLI 6485,
https://deepthought.juniper.net/app/do/showView?tableName=RLI&record_number=6485

[3] Tracking PR 550759,
https://gnats.juniper.net/web/default/550759


