z$Header: /cvs/juniper/sw-projects/os/nsr/rpd/rsvp/rsvp-oam-nsr-funcspec.txt,v 1.1 2010/09/14 17:29:19 anilgv Exp $

Process Template J3.02.P05.T01S

                NSR support for RSVP OAM (RLI 6485)
                ==================================
                Anil Kumar G V (anilgv@juniper.net)


Copyright (C) 2010, Juniper Networks, Inc.Template Owner(s):  Owner(s) of Software Development Process J3.02.P05
Template Version 1.41

NOTICE: This document contains proprietary and confidential 
information of Juniper Networks, Inc. and must not be distributed
outside of the company without the permission of Juniper Networks engineering.

1. Introduction:

   When NSR is configured, RSVP and BFD both replicate their state from 
   the master to the backup RE. This allows for both RSVP and BFD to be ready on the
   backup in case of a planned or unplanned RE-switchover. But RSVP OAM state is not
   being replicated currently. Therefore BFD sessions riding on RSVP LSPs will flap 
   on RE switchover.
  
   This RLI addresses this limitation by adding the NSR support for RSVP OAM. 

   Customers who run OAM on RSVP signaled LSPs and use NSR would like to
   use this feature.

   Currently, RPD protocols don't support NSR across logical routers and hence
   NSR for RSVP OAM will not work as expected for logical routers.

   Currently there is no OAM support for RSVP P2MP LSP and Therefore this feature
   doesnot apply for P2MP LSPs.

   Currently there is no OAM support for Bypass and Detour LSP and Therefore this
   feature doesnot apply for Bypass and Detour LSP.

   References:

     NSR support for RSVP has been added through 
        RLI 2720 (PR 97795) - NSR: MPLS and RSVP stateful replication for ingress
                                   and egress,
        RLI 3167 (PR 66381) - RSVP transit NSR and 
        RLI 4211 (PR 81731) - RSVP ingress NSR.
 
     NSR support for BFD has been added through 
        RLI 2726 (PR 94592).

     NSR support for LDP OAM has been added through
        RLI 6486 (PR 276691).

   Tracking information:

       RLI 6485
       PR 550759

2. Functionality

   This RLI adds functionality so that there is no detrimental effect of a RE
   switchover (when NSR is enabled) on RSVP OAM. Without the NSR support
   for RSVP OAM one would run into issues explained below.

   Consider the network shown below. Suppose in the paths A-B-C-D, A is the
   Ingress and D is the Egress. When OAM is enabled for the RSVP signaled LSP,
   a BFD session is setup for the LSP. Without NSR support for OAM, the
   current behavior during switchover is as follows.


   (Ingress)A------B------C------D(Egress)


   1. When the ingress LSR (i.e. A) undergoes a RE switchover, the
      ingress LSR would loose all the OAM state and it would have to
      reacquire all the OAM state after switchover.

   2. When the egress LSR (i.e. D) undergoes a RE switchover, the egress
      LSR would indicate to the ingress LSR (i.e. A) that the BFD session/s
      has go down.

   At present the operator would be allowed to configure failure action/s
   such as to teardown and re-signal the LSP upon a BFD failure event.
   So, the current behavior causes the following problems.

   1. Since the ingress LSR has to reacquire all the OAM state after switchover,
      any information regarding forwarding plane failures over a paths that are 
      known prior to switchover is lost. This would mean that if an LSP was in 
      the process of being torn-dowm and resignaled at the time of switchover,
      then this LSP will be activated after switchover until the failure of the
      path is detected again. 
      
   2. Since the egress LSR informs the ingress LSR of a BFD session
      failure after RE switchover, the ingress LSR will tear-down the LSP
      and re-signal the LSP. This would cause an unnecessary disruption on the 
      control plane and possibly packet loss for traffic flowing over the LSP.

   This RLI would address both these issues. 
   For the first issue, the ingress LSR would maintain the RSVP OAM state in standby RE
   so that it does not have to reacquire all the OAM state after the RE switchover. 
   For the second issue, the egress LSR will maintain the RSVP OAM state in standby RE
   so that the BFD session/s would not go down as a result of RE switchover. 


Goals 

   NSR support for RSVP OAM P2P LSP
  
Non-Goals

   NSR support for RSVP OAM P2MP LSP
   NSR support for RSVP OAM Bypass and Detour LSP
   NSR support for RSVP OAM on logical system

APIs/Messages (include intent)

   Not Applicable

CLI Config 

   There are no new configuration commands introduced by this rli.

CLI Commands 

   The command "show mpls lsp extensive" does not display any OAM related information on 
   the backup RE at present. With this new functionality, this command will display 
   identical OAM information as the primary RE.

   The commands described below are used only for internal debugging and
   troubleshooting purposes. Hence, they will be hidden.

   2.1 show mpls replication command (Hidden)
   ---------------------------------

   This command will display the replication state for RSVP OAM 

   regress@pro10-b> show mpls replication oam ?
   Possible completions:
     ldp                  Show ldp oam replication database
     rsvp                 Show rsvp oam replication database

   regress@pro10-b> show mpls replication oam rsvp ?
   Possible completions:
     <[Enter]> 
     <lsp-name>           Name of LSP
     detail               Display detailed output
     logical-systems      Name of logical system, or 'all'


   The "show mpls replication" command hierarchy is as below:

     |--oam
     |  |--ldp
     |  |   
     |  |--rsvp
     |     |--<lsp-name>
           |--detail               
           |--logical-systems

   2.2 show mpls replication command output (Hidden)
   ----------------------------------------

   This command will display the RSVP oam replication state for both the ingress
   and egress LSPs.

   Same output format for both master and backup

   Ingress:
   --------
   regress@pro10-b> show mpls replication oam rsvp
   Instance  Type      LSP Name         BFD dest addr  Local disc
   0         Ingress   lsp-one          127.0.0.1      1
     Refcount: 2, Address: 0x903baa0/0x90402b0

   {master/backup}

   regress@pro10-b> show mpls replication oam rsvp detail

   LSP-Name : lsp-one
     Type : Ingress
     ActivePath: pri (primary)
       BFD dest addr: 127.0.0.1
       Local disc: 1
     Refcount: 2, Address: 0x903baa0/0x90402b0

   {master/backup}

   Egress:
   -------
   regress@pro10-b> show mpls replication oam rsvp 
   Instance  Type      LSP Name         BFD dest addr  Local disc
   0         Egress    lsp-one          127.0.0.1      1
     Refcount: 2, Address: 0x903baa0/0x90402b0

   {master/backup}

   regress@pro10-b> show mpls replication oam rsvp detail

   LSP-Name : lsp-one
     Type : Egress    
     ActivePath: pri (primary)
     *Primary   pri           
       BFD dest addr: 127.0.0.1
       Local disc: 1
     Secondary sec              State: Dn
       BFD dest addr: 127.0.0.1
       Local disc: 1
     Refcount: 2, Address: 0x903baa0/0x90402b0

   {master/backup}


JUNOScript 

   regress@pro10-b> show mpls replication oam rsvp | display xml

   <rpc-reply xmlns:junos="http://xml.juniper.net/junos/11.1I0/junos">
       <mpls-oam-rsvp-replication-information xmlns="http://xml.juniper.net/junos/11.1I0/junos-routing">
           <mpls-oam-rsvp-replication>
               <mpls-oam-instance-id>0</mpls-oam-instance-id>
               <mpls-oam-type>Ingress</mpls-oam-type>
               <mpls-oam-lsp-name>lsp-one</mpls-oam-lsp-name>
               <mpls-oam-bfd-dest-addr>127.0.0.1</mpls-oam-bfd-dest-addr>
               <mpls-mirror-oam-local-bfd-disc>1</mpls-mirror-oam-local-bfd-disc>
           </mpls-oam-rsvp-replication>
       </mpls-oam-rsvp-replication-information>
       <cli>
           <banner>{master}</banner>
       </cli>
   </rpc-reply>

   regress@pro-bng3-e> show mpls replication oam rsvp detail | display xml
   <rpc-reply xmlns:junos="http://xml.juniper.net/junos/11.1I0/junos">
       <mpls-oam-rsvp-replication-information xmlns="http://xml.juniper.net/junos/11.1I0/junos-routing">
           <mpls-oam-rsvp-replication>
               <mpls-oam-instance-id>0</mpls-oam-instance-id>
               <mpls-oam-type>Ingress</mpls-oam-type>
               <mpls-oam-lsp-name>lsp-one</mpls-oam-lsp-name>
               <mpls-oam-bfd-dest-addr>127.0.0.1</mpls-oam-bfd-dest-addr>
               <mpls-mirror-oam-local-bfd-disc>1</mpls-mirror-oam-local-bfd-disc>
               <mpls-mirror-oam-refcount>1</mpls-mirror-oam-refcount>
               <mpls-mirror-oam-address>9084410</mpls-mirror-oam-address>
               <mpls-mirror-oam-mpls-oam-address>909aaa8</mpls-mirror-oam-mpls-oam-address>
           </mpls-oam-rsvp-replication>
       </mpls-oam-rsvp-replication-information>
       <cli>
           <banner>{master}</banner>
       </cli>
   </rpc-reply>


J-Web Quick Configuration and Monitor Screen

    None

SNMP
   
   None

Syslog - ERRMSG
  
   None

Assumptions

   1. There is a dependency on NSR support for RSVP and BFD.
      Any issues in these pre-existing features will likely affect.

   2. MPLS OAM frame work is done as part of NSR support for LDP OAM RLI.
      If any issues already exist, same may reflect in the new feature also.
  
   3. The BFD fault detection time that is configured MUST be larger than the
      expected fast-reroute time. 


Constraints and limitations
   
   1. Logical routers support will be added for this feature. 
      But logical routers may not work as expected.
      Currently RPD protocols don't support NSR across logical routers 
  
   2. NSR for P2MP RSVP OAM support is not added as part of this RLI

   3. NSR for Bypass and Detour LSP OAM support is not added as part of this RLI

   4. NSR for IPv6 RSVP P2P OAM is not considered as part of this RLI

Dependencies and interactions with other components in the system
 
   No extra interaction with other components

Examples or interaction descriptions

   None

Free software considerations:
 
  None

3.  PATENT OPPORTUNITIES

   None


4.  CAVEATS

   None


5.  OTHER REQUIREMENTS

   None

6.  IMPLEMENTATION DETAILS

   NSR support for BFD has been added through rli 2726. This means all
   the BFD state from the primary RE is replicated to backup RE. 
   The additional changes those are required for this rli is to associate
   the appropriate RSVP client with the BFD session that has been replicated 
   to the backup RE.

   One of the ways to associate a client with a BFD session is through the
   local BFD discriminator. The local BFD discriminator uniquely
   identifies a BFD session on the router.
 
   The basic framework has been added through rli 6486.
   When a client such as RSVP LSP requests BFD daemon to setup a BFD session
   over a LSP, BFD daemon creates the BFD session and informs the local BFD 
   discriminator to the client. RSVP then creates OAM state using this BFD 
   discriminator and associates this state with the LSP. RSVP now needs to 
   replicates this information to backup RE. This replication will be done 
   using the mirroring library.

   For both ingress oam (where the router is the ingress for an
   LSP) and egress oam(where the router is the egress node for an LSP), 
   the combination of LSP-ID, Tunnel-ID, Extended-Tunnel-ID,
   Src-address and dest-address will uniquely identify a RSVP LSP.
   
   So an RSVP OAM client can be uniquely identified by the quadruple 
   <RSVP-KEY(LSP-ID, Tunnel-ID, Extended-Tunnel-ID, Src-addr and dest-addr),
   Instance, Client-type and BFD dest address>.

   Since the framework is already present for MPLS OAM, RSVP OAM related key 
   need to be added to the following structure.

   typedef struct _mpls_oam_key {
       int mok_inst_id;
       mpls_oam_clnt_t mok_client;
       union {
           struct {
               in_addr mok_ldp_fec;            /* LDP FEC */
               u_int32_t mok_ldp_fec_len;      /* LDP FEC length */
               in_addr mok_ldp_src;            /* Address of the ingress LSR */
           } ldp_key;
         + struct {
         +      u_int16_t mok_rsvp_lsp_id            /* LSP ID */
         +      u_int16_t mok_rsvp_tunnel_id;        /* Tunnel ID */
         +      u_int32_t mok_rsvp_ext_tunnel_id;    /* Extended Tunnel ID */
         +      u_int32_t mok_rsvp_dst_addr;         /* IPv4 tunnel end point address for Egress */   
         +                                           /* IPv4 tunnel src address for Ingress */     
         +      u_int32_t mok_rsvp_snd_addr;         /* IPv4 tunnel sender address for Egress */   
         +                                           /* IPv4 tunnel end point address for Ingress */   
         + } rsvp_key;
       } mok_union;
       in_addr mok_dest; /* BFD destination address */
   } mpls_oam_key_t;

   Currently, the RSVP on backup RE ignores all RSVP OAM related
   configuration. This will be changed so that RSVP on backup RE creates
   necessary state based on RSVP OAM configuration. Further, it will learn
   RSVP OAM state and the local BFD discriminators through replication as 
   explained above. After this, RSVP will program BFD daemon running on 
   the backup similar to how it program this information on the primary RE.


7.  PERFORMANCE

 
7.1.  Performance Related Resources

   None

7.2.  Target Performance

   Minimal impact.
   RSVP and BFD replication is already present. 
   Incremental replication [RSVP OAM state] load is not expected to be significant.

8.  COMPATIBILITY ISSUES

   None


9.  SECURITY ISSUES

   None


10.  Platforms Supported

   Backup RE should available.

11.  Graceful RE Switchover (GRES), or ISSU Impact 

   N/A

12. NSR Impact
    
    This RLI adds to the existing NSR capability in MPLS OAM.
    Master RE replicates the RSVP OAM states using the mirror library.

13. Aggregated Ethernet/SONET Support
 
   N/A

14.  SDK Impact

   N/A

15. Services / JSF (JUNOS Services Framework) Impact

   N/A

16. MULTI-CHASSIS SUPPORT

   N/A

17. 64-BIT SUPPORT

   N/A


18. NOTES

   N/A

19.  GLOSSARY

   N/A

20.  REVIEW COMMENTS




