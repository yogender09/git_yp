$Id: ldp-oam-nsr-utp.txt,v 1.1 2008/05/28 09:55:36 rkandula Exp $

S3.02.P05.T02

Copyright (C) 2007, Juniper Networks, Inc.

NOTICE: This document contains the proprietary and confidential
information of Juniper Networks, Inc., and must not be
distributed outside of the company without the
permission of Juniper Engineering.

1.  INTRODUCTION

This is the unit test plan for LDP OAM NSR functionality.

RLI: 6486
Tracking PR: 276691
Functional spec:
http://cvs.juniper.net/cgi-bin/viewcvs.cgi/sw-projects/os/nsr/rpd/ldp/ldp-oam-nsr-funcspec.txt?rev=HEAD

2.  SETUP

Setup A:
                     +---------+         +---------+
                     | pro10-b |_________| pro10-c |
                     |   .1    |         |   .2    |
                     +----+----+         +----+----+
                                              |
                                              |
                                         +----+----+
                                         | pro10-f |
                                         |   .5    |
                                         +---------+

While denoting a router, the prefix "pro10-" is omitted. For example
router pro10-b is referred as router b. Similarly, while denoting a
link between two routers, the prefix "pro10-" is omitted. For example,
the link between b and e is denoted as link eb.

Summary of setup A:

o All the links are sonet links.
o All machines have ospf and ldp enabled on all interfaces.
o All machines are loaded with JUNOS 9.3.
o Router b is the DUT and the LSP to f's loopback address is the LSP
  that is used to test the functionality (i.e. FEC f).
o LDP OAM for FEC f is configured on router b.
o NSR is enabled on routers b and f.

Setup B:

                     +---------+         +---------+
                     | pro10-b |_________| pro10-c |
                     |   .1    |         |   .2    |
                     +----+----+         +----+----+
                          |                   |
                          |                   |
                     +----+----+         +----+----+
                     | pro10-e |_________| pro10-f |
                     |   .4    |         |   .5    |
                     +---------+         +---------+

Summary of setup B:

o All the links are sonet links.
o All machines have ospf and ldp enabled on all interfaces.
o All machines are loaded with JUNOS 9.3.
o Router b is the DUT and the LSP to f's loopback address is the LSP
  that is used to test the functionality (i.e. FEC f).
o The LSP to f on b will have two equal cost paths.
o LDP OAM for FEC f is configured on router b. ECMP and periodic
  traceroute for this FEC is enabled under bfd-liveness-detection.
o NSR is enabled on routers b and f.


3. FUNCTIONAL TEST CASES

3.1 Functionality related to Ingress LDP OAM (without ECMP).

3.1.1

Goal: LDP OAM programs BFD daemon appropriately on standby RE. 

Test Steps:
    1. Use setup A.
    2. Load all routers with default configs described in section 2.
    3. Wait till the BFD session is up.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM after a while.
    2. "show ldp oam" and "show ldp route detail" on standby RE should
        indicate that the BFD session correponding to FEC f is up.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that one mpls_mirror_oam data structure is in use on
        both primary and standby REs. 

Results: Pass


3.1.2

Goal: Disabling LDP OAM should clean up BFD session on standby RE. 

Test Steps:
    1. Follow the steps for test 3.1.1.
    2. Unconfigure the LDP OAM for FEC f.

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show ldp oam" and "show ldp route detail" should not display
       any OAM related state.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use on
        both REs.

Results: Pass


3.1.3

Goal: LDP OAM programs BFD daemon appropriately on standby RE upon
      restarting rpd on standby RE. 

Test Steps:
    1. Follow the steps for test 3.1.1
    2. Wait till the BFD session on standby RE indicate that the
       client is LDP-OAM.
    3. Restart rpd on standby RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM after a while.
    2. "show ldp oam" and "show ldp route detail" on standby RE should
        indicate that the BFD session correponding to FEC f is up.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that one mpls_mirror_oam data structure is in use.

Results: Pass


3.1.4

Goal: LDP OAM programs BFD deamon appropriately on standby RE upon
      restarting rpd on master RE.

Test Steps:
    1. Follow the steps for test 3.1.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is LDP-OAM.
    3. Restart rpd on master RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM after a while.
    2. "show ldp oam" and "show ldp route detail" on standby RE should
        indicate that the BFD session correponding to FEC f is up.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that one mpls_mirror_oam data structure is in use.

Results: Pass


3.1.5

Goal: LDP OAM cleans up ingress BFD session on standby RE properly
      when LSP goes down. 

Test Steps:
    1. Follow the steps for test 3.1.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is LDP-OAM.
    3. Configure an LDP egress policy which excludes FEC f on router f

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show ldp oam" and "show ldp route detail" should not display
       any OAM related state.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.

Results: Pass

3.1.6

Goal: Ingress BFD session on new master RE stay up on RE switchover.

Test Steps:
    1. Follow the steps for test 3.1.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is LDP-OAM.
    3. Do a RE switchover.

Success Criteria:
    1. Make sure the BFD session stays up on switchover.
    2. Make sure the LSP ping state goes to up after a while.

Results: Pass


3.2 Functionality related to Ingress LDP OAM (with ECMP).

3.2.1

Goal: LDP OAM with ECMP enabled programs BFD daemon appropriately on standby RE. 

Test Steps:
    1. Use setup B.
    2. Load all routers with default configs described in section 2.
    3. Wait till the BFD sessions for the two paths are up.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for both BFD sessions.
    2. "show ldp oam" and "show ldp route detail" on standby RE should
        indicate that the two BFD sessions correponding to FEC f are up.
    3. Further "show ldp oam" output on both REs should be identical
       in terms of the paths discovered by traceroute.
    4. "show task memory detail | match mpls_mirror_oam" should
        indicate that two mpls_mirror_oam data structures are in use.
    5. "show task memory detail | match tracert" should indicate that
        one ldp_mirror_tracert data structure is in use.

Results: Pass


3.2.2

Goal: Disabling LDP OAM with ECMP enabled should clean up BFD sessions on standby RE. 

Test Steps:
    1. Follow the steps for test 3.2.1.
    2. Deconfigure the LDP OAM for FEC f.

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show ldp oam" and "show ldp route detail" should not display
       any OAM related state.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.
    4. "show task memory detail | match tracert" should indicate that
       no ldp_mirror_tracert datastructures are in use.

Results: Fail

Note: On standby RE this caused a core dump. This will be fixed as
      part of the PR listed in "DEFECTS REMAINING" section.


3.2.3

Goal: LDP OAM with ECMP enabled programs BFD daemon appropriately on standby RE upon
      restarting rpd on standby RE. 

Test Steps:
    1. Follow the steps for test 3.2.1
    2. Wait till the BFD sessions on standby RE indicate that the
       client is LDP-OAM.
    3. Restart rpd on standby RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for both BFD sessions after a while.
    2. "show ldp oam" and "show ldp route detail" on standby RE should
        indicate that the two BFD sessions correponding to FEC f are up.
    3. Further "show ldp oam" output on both REs should be identical
       in terms of the paths discovered by traceroute.
    4. "show task memory detail | match mpls_mirror_oam" should
        indicate that two mpls_mirror_oam data structures are in use.
    5. "show task memory detail | match tracert" should indicate that
        one ldp_mirror_tracert data structure is in use.

Results: Pass


3.2.4

Goal: LDP OAM with ECMP enabled programs BFD daemon appropriately on standby RE upon
      restarting rpd on master RE.

Test Steps:
    1. Follow the steps for test 3.2.1.
    2. Wait till the BFD sessions on standby RE indicate that the
       client is LDP-OAM.
    3. Restart rpd on master RE.

Success Criteria:
    1. On standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for both BFD sessions.
    2. "show ldp oam" and "show ldp route detail" on standby RE should
        indicate that the two BFD sessions correponding to FEC f are up.
    3. Further "show ldp oam" output on both REs should be identical
       in terms of the paths discovered by traceroute.
    4. "show task memory detail | match mpls_mirror_oam" should
        indicate that two mpls_mirror_oam data structures are in use.
    5. "show task memory detail | match tracert" should indicate that
        one ldp_mirror_tracert data structure is in use.

Results: Pass


3.2.5

Goal: LDP OAM with ECMP enabled cleans up ingress BFD sessions on standby RE properly
      when LSP goes down.

Test Steps:
    1. Follow the steps for test 3.2.1.
    2. Wait till the BFD sessions on standby RE indicate that the
       client is LDP-OAM.
    3. Configure an LDP egress policy which excludes FEC f on router f

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show ldp oam" and "show ldp route detail" should not display
       any OAM related state.
    3. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.
    4. "show task memory detail | match tracert" should indicate that
        no ldp_mirror_tracert data structures are in use.

Results: Pass

3.2.6

Goal: LDP OAM ingress BFD sessions on new master RE stay up on RE switchover.

Test Steps:
    1. Follow the steps for test 3.2.1.
    2. Wait till the BFD session on standby RE indicate that the
       client is LDP-OAM.
    3. Do a RE switchover.

Success Criteria:
    1. Make sure the BFD sessions stay up on switchover.
    2. Make sure the LSP ping state goes to up after a while.

Results: Pass


3.3 Functionality related to Egress OAM

For all the test cases in the section, the DUT is router f.

3.3.1

Goal: Egress LDP OAM programs BFD daemon appropriately on standby RE. 

Test Steps:
    1. Use setup B.
    2. Load all routers with default configs described in section 2.
    3. Wait till the egress BFD sessions for the two paths are up on
       router f.

Success Criteria:
    1. On router f's standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for both egress BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that two mpls_mirror_oam data structures are in use.

Results: Pass


3.3.2

Goal: Disabling LDP should clean up egress BFD sessions on standby RE. 

Test Steps:
    1. Follow the steps for test 3.3.1.
    2. Disable LDP on f.

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.

Results: Pass


3.3.3

Goal: Egress LDP OAM programs BFD daemon appropriately on standby RE upon
      restarting rpd on standby RE. 

Test Steps:
    1. Follow the steps for test 3.3.1
    2. Restart rpd on standby RE.

Success Criteria:
    1. On router f's standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for both egress BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that two mpls_mirror_oam data structures are in use.

Results: Pass


3.3.4

Goal: Egress LDP OAM programs BFD daemon appropriately on standby RE upon
      restarting rpd on master RE. 

Test Steps:
    1. Follow the steps for test 3.3.1
    2. Restart rpd on master RE.
    3. Wait till the egress BFD sessions are up on master RE.

Success Criteria:
    1. On router f's standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for both egress BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that two mpls_mirror_oam data structures are in use.

Results: Pass


3.3.5

Goal: Egress LDP OAM cleans up BFD sessions on standby RE properly
      when the LDP OAM is unconfigured on ingress LSR.

Test Steps:
    1. Follow the steps for test 3.3.1.
    2. Wait till the BFD sessions on standby RE indicate that the
       client is LDP-OAM.
    3. Unconfigure OAM on the ingress LSR b.

Success Criteria:
    1. On standby RE "show bfd session" should not display any BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that no mpls_mirror_oam data structures are in use.

Results: Pass


3.3.6

Goal: Egress LDP OAM programs BFD properly on standby RE when there
      are BFD sessions from multiple ingress LSRs for the same FEC.

Test Steps:
    1. Configure OAM for FEC f on routers b, c and e.
    2. Wait till there are four egress BFD sessions on f's master RE.

Success Criteria:
    1. On router f's standby RE "show bfd session detail" should indicate that
       the client is LDP-OAM for all 4 egress BFD sessions.
    2. "show task memory detail | match mpls_mirror_oam" should
        indicate that four mpls_mirror_oam data structures are in use.


3.3.7

Goal: Egress LDP OAM BFD sessions on new master RE stay up on RE switchover.

Test Steps:
    1. Follow the steps for test 3.3.6.
    2. Do a RE switchover.

Success Criteria:
    1. Make sure the BFD sessions on the new master are still up.

Results: Pass


4.  BOUNDARY TEST CASES

4.1.1

Goal: LDP OAM links with the BFD session on standby RE even when the
      BFD session is not in the Up state.

Test Steps:
    1. Follow the steps for test 3.1.1
    2. Wait till the BFD session on standy RE indicate that the
       client is LDP-OAM.
    3. Configure a firewall filter on router f that rejects BFD
       packets so that BFD session on the ingress router b goes down.
    4. Do a RE switchover and wait.

Success Criteria:
    1. On the new standby RE, the BFD session which would be down should
       indicate that the client is LDP-OAM.

4.1.2

Goal: LDP OAM with ECMP enabled links with the BFD sessions on standby RE even when the
      BFD sessions are not in the Up state.

Test Steps:
    1. Follow the steps for test 3.2.1
    2. Wait till the BFD sessions on standy RE indicate that the
       client is LDP-OAM.
    3. Configure a firewall filter on router f that rejects BFD
       packets so that BFD sessions on the ingress router b go down.
    4. Do a RE switchover and wait.

Success Criteria:
    1. On the new standby RE, the BFD sessions which would be down should
       indicate that the client is LDP-OAM.

5.  GRES TEST CASES


6. TX TEST CASES

There is nothing in this RLI which is specific to TX series.

7.  REGRESSION TEST CASES


8.  INTEROP TEST CASES


9.  MIGRATION & COMPATIBILITY TEST CASES


10.  TEST COVERAGE REMAINING

This unit test plan does not cover the scenario when LDP tunnels over
RSVP. At present there is no RSVP NSR support. When we do support NSR
for RSVP, we need to test this scenario.

11.  DEFECTS REMAINING

PR: 294428

